<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HexBreaker Editor</title>
    <link rel="stylesheet" href="css/editor.css">
    <link rel="stylesheet" href="css/dialogs.css">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <div class="editor-container">
        <!-- Menu Bar -->
        <nav class="menu-bar">
            <div class="menu-item" data-menu="file">
                ファイル
                <div class="menu-dropdown">
                    <div class="menu-dropdown-item" id="menu-new">
                        <span>新規作成</span>
                        <span class="shortcut">Ctrl+N</span>
                    </div>
                    <div class="menu-dropdown-item" id="menu-open">
                        <span>開く</span>
                        <span class="shortcut">Ctrl+O</span>
                    </div>
                    <div class="menu-dropdown-item" id="menu-save">
                        <span>保存</span>
                        <span class="shortcut">Ctrl+S</span>
                    </div>
                    <div class="menu-dropdown-item" id="menu-save-as">
                        <span>別名で保存</span>
                        <span class="shortcut">Ctrl+Shift+S</span>
                    </div>
                    <div class="context-menu-separator"></div>
                    <div class="menu-dropdown-item" id="menu-export">
                        <span>エクスポート</span>
                    </div>
                </div>
            </div>
            <div class="menu-item" data-menu="edit">
                編集
                <div class="menu-dropdown">
                    <div class="menu-dropdown-item" id="menu-undo">
                        <span>元に戻す</span>
                        <span class="shortcut">Ctrl+Z</span>
                    </div>
                    <div class="menu-dropdown-item" id="menu-redo">
                        <span>やり直す</span>
                        <span class="shortcut">Ctrl+Y</span>
                    </div>
                </div>
            </div>
            <div class="menu-item" data-menu="view">
                表示
                <div class="menu-dropdown">
                    <div class="menu-dropdown-item" id="menu-toggle-grid">
                        <span>グリッド表示</span>
                        <span class="shortcut">H</span>
                    </div>
                    <div class="menu-dropdown-item" id="menu-toggle-lines">
                        <span>線分表示</span>
                    </div>
                    <div class="menu-dropdown-item" id="menu-reset-view">
                        <span>ビューをリセット</span>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Toolbar -->
        <div class="toolbar">
            <div class="toolbar-group">
                <button class="btn btn--icon" id="btn-new" data-tooltip="新規作成">
                    <i class="fas fa-file"></i>
                </button>
                <button class="btn btn--icon" id="btn-open" data-tooltip="開く">
                    <i class="fas fa-folder-open"></i>
                </button>
                <button class="btn btn--icon" id="btn-save" data-tooltip="保存">
                    <i class="fas fa-save"></i>
                </button>
            </div>

            <div class="toolbar-separator"></div>

            <div class="toolbar-group">
                <button class="btn btn--icon" id="btn-undo" data-tooltip="元に戻す (Ctrl+Z)">
                    <i class="fas fa-undo"></i>
                </button>
                <button class="btn btn--icon" id="btn-redo" data-tooltip="やり直す (Ctrl+Y)">
                    <i class="fas fa-redo"></i>
                </button>
            </div>

            <div class="toolbar-separator"></div>

            <div class="toolbar-group view-toggle">
                <label>
                    <input type="checkbox" id="grid-toggle" checked>
                    グリッド
                </label>
                <label>
                    <input type="checkbox" id="line-toggle" checked>
                    ライン
                </label>
            </div>

            <div class="toolbar-separator"></div>

            <div class="toolbar-group">
                <label class="label" style="margin-right: 4px;">ステージ:</label>
                <select class="select" id="stage-select" style="min-width: 120px;">
                    <!-- Populated dynamically -->
                </select>
                <button class="btn btn--icon btn--small" id="btn-add-stage" data-tooltip="新規ステージ">
                    <i class="fas fa-plus"></i>
                </button>
            </div>

            <div class="toolbar-separator"></div>

            <div class="toolbar-separator"></div>

            <div class="toolbar-group">
                <button class="btn btn--icon btn--primary" id="btn-preview" data-tooltip="プレビュー (P)">
                    <i class="fas fa-play"></i>
                    プレビュー
                </button>
            </div>

            <div class="toolbar-group zoom-controls">
                <button class="btn btn--icon btn--small" id="btn-zoom-out">
                    <i class="fas fa-search-minus"></i>
                </button>
                <span id="zoom-level" class="zoom-level">100%</span>
                <button class="btn btn--icon btn--small" id="btn-zoom-in">
                    <i class="fas fa-search-plus"></i>
                </button>
            </div>
        </div>

        <!-- Left Panel -->
        <div class="left-panel">
            <!-- Tool Palette -->
            <div class="panel-section">
                <div class="panel-title">ツール</div>
                <div class="tool-palette" id="tool-palette">
                    <!-- Row 1: ペン、消しゴム、線分 -->
                    <button class="tool-btn active" id="tool-brush" data-tooltip="ブラシ (B)">
                        <i class="fas fa-paint-brush"></i>
                    </button>
                    <button class="tool-btn" id="tool-eraser" data-tooltip="消しゴム (E)">
                        <i class="fas fa-eraser"></i>
                    </button>
                    <button class="tool-btn" id="tool-line" data-tooltip="ライン (L)">
                        <i class="fas fa-bezier-curve"></i>
                    </button>
                    <!-- Row 2: 選択、塗りつぶし、スポイト -->
                    <button class="tool-btn" id="tool-select" data-tooltip="選択 (V)">
                        <i class="fas fa-mouse-pointer"></i>
                    </button>
                    <button class="tool-btn" id="tool-fill" data-tooltip="塗りつぶし (G)">
                        <i class="fas fa-fill-drip"></i>
                    </button>
                    <button class="tool-btn" id="tool-eyedropper" data-tooltip="スポイト (I)">
                        <i class="fas fa-eye-dropper"></i>
                    </button>
                </div>
            </div>

            <!-- Brush Size -->
            <div class="panel-section">
                <div class="panel-title">ブラシサイズ</div>
                <div class="brush-size-selector">
                    <button class="brush-size-btn" id="brush-s">S</button>
                    <button class="brush-size-btn active" id="brush-m">M</button>
                    <button class="brush-size-btn" id="brush-l">L</button>
                </div>
            </div>

            <!-- Block Settings -->
            <div class="panel-section">
                <div class="panel-title">ブロック設定</div>
                <div class="form-group">
                    <label class="label">耐久値</label>
                    <div class="durability-selector">
                        <button class="durability-btn active" data-durability="1"
                            style="background-color: #64B5F6;">1</button>
                        <button class="durability-btn" data-durability="2" style="background-color: #4FC3F7;">2</button>
                        <button class="durability-btn" data-durability="3" style="background-color: #4DD0E1;">3</button>
                        <button class="durability-btn" data-durability="4" style="background-color: #4DB6AC;">4</button>
                        <button class="durability-btn" data-durability="5" style="background-color: #81C784;">5</button>
                        <button class="durability-btn" data-durability="6" style="background-color: #AED581;">6</button>
                        <button class="durability-btn" data-durability="7" style="background-color: #DCE775;">7</button>
                        <button class="durability-btn" data-durability="8" style="background-color: #FFD54F;">8</button>
                        <button class="durability-btn" data-durability="9" style="background-color: #FF8A65;">9</button>
                        <button class="durability-btn" data-durability="10"
                            style="background-color: #E57373;">10</button>
                    </div>
                </div>
                <div class="form-group">
                    <label class="label">色</label>
                    <input type="color" class="color-picker" id="block-color" value="#64B5F6">
                </div>
            </div>

            <!-- Block Render Settings (collapsible) -->
            <div class="panel-section collapsible">
                <div class="panel-title collapsible-header" id="block-render-toggle">
                    <span>ブロック描画設定</span>
                    <span class="collapse-icon">▼</span>
                </div>
                <div class="collapsible-content" id="block-render-content">
                    <!-- 塗り設定 -->
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="fill-use-block-color" checked>
                            ブロック色を使用
                        </label>
                    </div>
                    <div class="form-group" id="fill-color-group">
                        <label class="label">塗りの色</label>
                        <input type="color" class="color-picker" id="fill-color" value="#888888" disabled>
                    </div>
                    <div class="form-group">
                        <label class="label">塗りの不透明度 <span id="fill-opacity-value">100</span>%</label>
                        <input type="range" class="slider" id="fill-opacity" value="100" min="0" max="100" step="5">
                    </div>
                    <!-- 境界線設定 -->
                    <div class="form-group">
                        <label class="label">境界線の色</label>
                        <input type="color" class="color-picker" id="border-color" value="#ffffff">
                    </div>
                    <div class="form-group">
                        <label class="label">境界線の太さ <span id="border-width-value">3</span>%</label>
                        <input type="range" class="slider" id="border-width" value="3" min="0" max="10" step="0.5">
                    </div>
                    <div class="form-group">
                        <label class="label">エンボス ハイライト色</label>
                        <input type="color" class="color-picker" id="emboss-highlight-color" value="#ffffff">
                    </div>
                    <div class="form-group">
                        <label class="label">ハイライト不透明度 <span id="emboss-highlight-opacity-value">50</span>%</label>
                        <input type="range" class="slider" id="emboss-highlight-opacity" value="50" min="0" max="100" step="5">
                    </div>
                    <div class="form-group">
                        <label class="label">エンボス シャドウ色</label>
                        <input type="color" class="color-picker" id="emboss-shadow-color" value="#000000">
                    </div>
                    <div class="form-group">
                        <label class="label">シャドウ不透明度 <span id="emboss-shadow-opacity-value">40</span>%</label>
                        <input type="range" class="slider" id="emboss-shadow-opacity" value="40" min="0" max="100" step="5">
                    </div>
                    <div class="form-group">
                        <label class="label">エンボス太さ <span id="emboss-width-value">8</span>%</label>
                        <input type="range" class="slider" id="emboss-width" value="8" min="0" max="20" step="1">
                    </div>
                    <div class="form-group">
                        <label class="label">エンボス内側距離 <span id="emboss-inset-value">10</span>%</label>
                        <input type="range" class="slider" id="emboss-inset" value="10" min="5" max="30" step="1">
                    </div>
                </div>
            </div>

            <div class="divider"></div>

            <!-- Line Properties -->
            <div class="panel-section">
                <div class="panel-title">ライン設定</div>
                <div class="line-type-selector">
                    <button class="line-type-btn active" data-type="collision">壁</button>
                    <button class="line-type-btn" data-type="paddle">パドル</button>
                    <button class="line-type-btn" data-type="missline">ミス</button>
                    <button class="line-type-btn" data-type="decoration">装飾</button>
                    <button class="line-type-btn" data-type="path">パス</button>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="label">色</label>
                        <input type="color" class="color-picker" id="line-color" value="#FFFF00">
                    </div>
                    <div class="form-group">
                        <label class="label">太さ</label>
                        <input type="number" class="input input--small" id="line-thickness" value="3" min="1" max="20">
                    </div>
                </div>
                <div class="form-group">
                    <label class="label">不透明度</label>
                    <input type="range" class="slider" id="line-opacity" value="1" min="0" max="1" step="0.1">
                </div>
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="grid-snap" checked>
                        グリッドスナップ
                    </label>
                </div>

                <!-- パドルライン設定（パドルライン選択時のみ表示） -->
                <div id="paddle-settings" style="display: none;">
                    <div class="form-group">
                        <label class="label">パドル操作</label>
                        <select id="paddle-control" class="select">
                            <option value="mouse-x">マウス(横)</option>
                            <option value="mouse-y">マウス(縦)</option>
                            <option value="mouse-x-inv">マウス(横・反転)</option>
                            <option value="mouse-y-inv">マウス(縦・反転)</option>
                            <option value="key-x">キーボード(横)</option>
                            <option value="key-y">キーボード(縦)</option>
                            <option value="key-x-inv">キーボード(横・反転)</option>
                            <option value="key-y-inv">キーボード(縦・反転)</option>
                            <option value="auto">自動</option>
                            <option value="tap">タップ</option>
                        </select>
                    </div>
                    <div id="tap-settings" style="display: none;">
                        <div class="form-group">
                            <label class="label">タップエリア幅(px)</label>
                            <input type="number" class="input input--small" id="tap-range" value="40" min="10" max="200">
                        </div>
                    </div>
                </div>

                <!-- パス紐づけ設定（パドル/ミスライン選択時のみ表示） -->
                <div id="path-settings" style="display: none;">
                    <div class="form-group">
                        <label class="label">パスライン</label>
                        <select id="path-line-select" class="select">
                            <option value="">なし</option>
                        </select>
                    </div>
                    <div id="path-speed-settings" style="display: none;">
                        <div class="form-group">
                            <label class="label">移動速度(px/s)</label>
                            <input type="number" class="input input--small" id="path-speed" value="100" min="10" max="500">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Canvas Container -->
        <div class="canvas-container">
            <div class="canvas-wrapper">
                <canvas id="mainCanvas" width="1280" height="720"></canvas>
                <canvas id="overlayCanvas" width="1280" height="720"></canvas>
            </div>
            <div class="canvas-info">
                <span id="canvas-size-info">1280 x 720</span>
                <span id="cursor-pos-info">X: 0, Y: 0</span>
                <span id="hex-pos-info">Row: 0, Col: 0</span>
            </div>
        </div>

        <!-- Right Panel -->
        <div class="right-panel">
            <!-- Tabs -->
            <div class="panel-tabs">
                <button class="panel-tab active" data-tab="layers">レイヤー</button>
                <button class="panel-tab" data-tab="stages">ステージ</button>
            </div>

            <!-- Layer Tab -->
            <div class="panel-content" id="tab-layers">
                <div class="layer-list" id="layer-list">
                    <!-- Layers will be rendered here -->
                </div>
                <button class="add-layer-btn" id="btn-add-image">
                    <i class="fas fa-image"></i>
                    画像レイヤーを追加
                </button>
                <button class="add-layer-btn" id="btn-add-block-layer">
                    <i class="fas fa-cubes"></i>
                    ブロックレイヤーを追加
                </button>
            </div>

            <!-- Stage Tab (hidden by default) -->
            <div class="panel-content hidden" id="tab-stages">
                <div class="stage-list" id="stage-list">
                    <!-- Stages will be rendered here -->
                </div>
                <button class="add-layer-btn" id="btn-create-stage">
                    <i class="fas fa-plus"></i>
                    ステージを作成
                </button>
            </div>
        </div>

        <!-- Message Panel -->
        <div class="message-panel">
            <div class="message-header">
                <span class="message-title">メッセージ</span>
                <div class="message-header-buttons">
                    <button class="message-copy-all-btn" id="btn-copy-messages" title="全てコピー">📋</button>
                    <button class="message-clear-btn" id="btn-clear-messages">クリア</button>
                </div>
            </div>
            <div class="message-list" id="message-list">
                <div class="message info">
                    <span class="message-icon">ℹ️</span>
                    <span class="message-text">HexBreaker Editor へようこそ！</span>
                </div>
            </div>
        </div>
    </div>

    <!-- New Stage Dialog -->
    <div class="modal-overlay hidden" id="new-stage-dialog">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">新規ステージ作成</span>
                <button class="modal-close" id="new-stage-cancel">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="label">ステージ名</label>
                    <input type="text" class="input" id="new-stage-name" placeholder="Stage 1" value="">
                </div>

                <div class="form-group">
                    <label class="label">ベース画像（オプション）</label>
                    <input type="file" class="input" id="new-stage-image" accept="image/png,image/jpeg,image/gif">
                    <small style="color: var(--color-text-muted); display: block; margin-top: 4px;">
                        画像サイズがキャンバスサイズとして使用されます
                    </small>
                </div>

                <div class="form-group">
                    <label class="label">キャンバスサイズ（手動設定）</label>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <input type="number" class="input" id="new-stage-width" value="1280" style="width: 80px;">
                        <span>×</span>
                        <input type="number" class="input" id="new-stage-height" value="720" style="width: 80px;">
                        <span>px</span>
                    </div>
                </div>

                <div class="form-group">
                    <label class="label">グリッドサイズ（ブロック密度）</label>
                    <div style="display: flex; flex-direction: column; gap: 4px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="radio" name="grid-size" value="small">
                            <span>小 (10px) - 細かいブロック</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="radio" name="grid-size" value="medium" checked>
                            <span>中 (30px) - 標準</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="radio" name="grid-size" value="large">
                            <span>大 (50px) - 大きいブロック</span>
                        </label>
                    </div>
                    <small style="color: var(--color-warning); display: block; margin-top: 8px;">
                        ⚠ グリッドサイズは作成後に変更できません
                    </small>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn--secondary" id="new-stage-cancel-btn">キャンセル</button>
                <button class="btn btn--primary" id="new-stage-create-btn">作成</button>
            </div>
        </div>
    </div>

    <!-- Blockify Dialog -->
    <div class="modal-overlay hidden" id="blockify-dialog">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">ブロック化</span>
                <button class="modal-close" id="blockify-close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="label">ソース画像レイヤー</label>
                    <select class="select" id="blockify-source" style="width: 100%;">
                        <!-- Populated dynamically -->
                    </select>
                    <small style="color: var(--color-text-muted);">
                        背景透過のPNG画像を使用してください
                    </small>
                </div>

                <div class="form-group">
                    <label class="label">カバレッジしきい値: <span id="blockify-coverage-value">30%</span></label>
                    <input type="range" class="slider" id="blockify-coverage-threshold"
                        min="0.1" max="1" step="0.05" value="0.3" style="width: 100%;">
                    <small style="color: var(--color-text-muted);">
                        ヘックス内のこの割合以上が不透明ならブロック配置
                    </small>
                </div>

                <div class="form-group">
                    <label class="label">デフォルト耐久値</label>
                    <select class="select" id="blockify-durability" style="width: 100%;">
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                    </select>
                </div>

                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="blockify-use-image-color" checked>
                        <span>画像から色を抽出</span>
                    </label>
                </div>

                <div class="form-group">
                    <label class="label">デフォルト色</label>
                    <input type="color" class="color-picker" id="blockify-default-color" value="#64B5F6">
                </div>

                <hr style="border-color: var(--color-border); margin: 16px 0;">

                <div class="form-group">
                    <label class="label">出力先</label>
                    <select class="select" id="blockify-target" style="width: 100%;">
                        <option value="">新規ブロックレイヤー</option>
                        <!-- Existing block layers populated dynamically -->
                    </select>
                </div>

                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="blockify-merge-blocks">
                        <span>既存ブロックとマージ（上書きしない）</span>
                    </label>
                </div>

                <div class="form-group" style="background: var(--color-bg-secondary); padding: 12px; border-radius: 4px;">
                    <label class="label">プレビュー</label>
                    <p style="margin: 8px 0 0 0;">
                        生成ブロック数: <strong id="blockify-preview-count">0</strong>
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn--secondary" id="blockify-cancel-btn">キャンセル</button>
                <button class="btn btn--primary" id="blockify-create-btn">ブロック化実行</button>
            </div>
        </div>
    </div>

    <!-- Layer Context Menu -->
    <div class="context-menu hidden" id="layer-context-menu">
        <!-- Items populated dynamically -->
    </div>

    <!-- Startup Dialog -->
    <div class="modal-overlay" id="startup-dialog">
        <div class="modal startup-modal">
            <div class="startup-header">
                <h1 class="startup-title">HexBreaker Editor</h1>
                <p class="startup-subtitle">ヘックスグリッド ブロック崩しエディター</p>
            </div>
            <div class="startup-buttons">
                <button class="startup-btn startup-btn--primary" id="btn-startup-new">
                    <i class="fas fa-plus"></i>
                    <span>新規プロジェクト</span>
                </button>
                <button class="startup-btn startup-btn--secondary" id="btn-startup-open">
                    <i class="fas fa-folder-open"></i>
                    <span>プロジェクトを開く</span>
                </button>
            </div>
        </div>
    </div>

    <!-- New Project Wizard -->
    <div class="modal-overlay hidden" id="new-project-wizard">
        <div class="modal wizard-modal">
            <div class="wizard-header">
                <span class="modal-title">新規プロジェクト作成</span>
                <div class="wizard-steps">
                    <div class="step-indicator active" data-step="1">1</div>
                    <div class="step-connector"></div>
                    <div class="step-indicator" data-step="2">2</div>
                    <div class="step-connector"></div>
                    <div class="step-indicator" data-step="3">3</div>
                </div>
            </div>

            <!-- Step 1: Base Layer -->
            <div class="wizard-step" id="wizard-step-1">
                <div class="wizard-step-title">ベースレイヤーの設定</div>
                <div class="wizard-step-desc">背景画像または単色を選択してください</div>

                <div class="wizard-content">
                    <!-- Tab Selector -->
                    <div class="wizard-tabs" id="wizard-base-tabs">
                        <button class="wizard-tab active" data-tab="image">
                            <i class="fas fa-image"></i> 画像
                        </button>
                        <button class="wizard-tab" data-tab="solid">
                            <i class="fas fa-fill-drip"></i> 単色
                        </button>
                    </div>

                    <!-- Image Tab Content -->
                    <div class="wizard-tab-content" id="wizard-tab-image">
                        <div class="drop-zone" id="wizard-drop-zone">
                            <div class="drop-zone-content">
                                <i class="fas fa-image drop-zone-icon"></i>
                                <p>画像をドラッグ＆ドロップ</p>
                                <p class="drop-zone-hint">または</p>
                                <button class="btn btn--secondary" id="btn-wizard-select-image">
                                    ファイルを選択
                                </button>
                            </div>
                        </div>
                        <input type="file" id="file-input-wizard-image" accept="image/*" style="display:none">

                        <!-- Image Preview -->
                        <div class="image-preview-container hidden" id="wizard-image-preview">
                            <img id="wizard-preview-img" class="preview-img" alt="Preview">
                            <div class="preview-info">
                                <span id="wizard-image-name">image.png</span>
                                <span id="wizard-image-size">1280 x 720 px</span>
                            </div>
                            <button class="btn btn--icon btn--small" id="btn-wizard-clear-image">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Solid Color Tab Content -->
                    <div class="wizard-tab-content hidden" id="wizard-tab-solid">
                        <div class="wizard-solid-row">
                            <div class="wizard-panel wizard-solid-panel" id="wizard-color-panel">
                                <label class="label">背景色</label>
                                <div class="color-preset-grid">
                                    <button class="bg-color-preset" data-color="#FFFFFF" style="background:#FFFFFF" title="白"></button>
                                    <button class="bg-color-preset" data-color="#000000" style="background:#000000" title="黒"></button>
                                    <button class="bg-color-preset selected" data-color="#808080" style="background:#808080" title="グレー"></button>
                                    <button class="bg-color-preset" data-color="#333333" style="background:#333333" title="ダークグレー"></button>
                                </div>
                            </div>
                            <div class="wizard-panel wizard-solid-panel" id="wizard-size-panel">
                                <label class="label">サイズ</label>
                                <div class="size-preset-buttons">
                                    <button class="size-preset-btn" data-width="1280" data-height="720">1280×720</button>
                                    <button class="size-preset-btn" data-width="1920" data-height="1080">1920×1080</button>
                                    <button class="size-preset-btn" data-width="800" data-height="600">800×600</button>
                                </div>
                                <div class="size-inputs">
                                    <input type="number" class="input" id="wizard-width" value="1280" min="100" max="4096">
                                    <span>×</span>
                                    <input type="number" class="input" id="wizard-height" value="720" min="100" max="4096">
                                    <span>px</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="wizard-footer">
                    <button class="btn btn--secondary" id="btn-wizard-cancel-1" disabled>キャンセル</button>
                    <button class="btn btn--primary" id="btn-wizard-step1-next" disabled>次へ</button>
                </div>
            </div>

            <!-- Step 2: Paddle Area -->
            <div class="wizard-step hidden" id="wizard-step-2">
                <div class="wizard-step-title">パドル領域の設定</div>
                <div class="wizard-step-desc">追加領域とプリセットを設定してください</div>

                <div class="wizard-content">
                    <!-- Extra Area Mode -->
                    <label class="label">追加領域</label>
                    <div class="option-cards">
                        <div class="extra-area-card selected" data-mode="none">
                            <i class="fas fa-square"></i>
                            <span>なし</span>
                            <small>画像サイズのまま</small>
                        </div>
                        <div class="extra-area-card" data-mode="external">
                            <i class="fas fa-expand"></i>
                            <span>追加領域あり</span>
                            <small>パドル用スペースを追加</small>
                        </div>
                    </div>

                    <!-- Extra Area Settings -->
                    <div class="wizard-panel hidden" id="wizard-extra-area-settings">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="label">位置</label>
                                <select class="select" id="wizard-extra-position">
                                    <option value="bottom">下</option>
                                    <option value="top">上</option>
                                    <option value="left">左</option>
                                    <option value="right">右</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="label">サイズ (px)</label>
                                <input type="number" class="input" id="wizard-extra-size" value="100" min="50" max="500">
                            </div>
                        </div>
                    </div>

                    <div class="form-divider"></div>

                    <!-- Paddle Axis Preset -->
                    <label class="label">パドル軸の自動生成</label>
                    <div class="preset-cards">
                        <div class="paddle-preset-card selected" data-preset="auto">
                            <i class="fas fa-magic"></i>
                            <span>自動</span>
                        </div>
                        <div class="paddle-preset-card" data-preset="none">
                            <i class="fas fa-ban"></i>
                            <span>なし</span>
                        </div>
                    </div>

                    <!-- Missline Preset -->
                    <label class="label">ミスラインの自動生成</label>
                    <div class="preset-cards">
                        <div class="missline-preset-card selected" data-preset="auto">
                            <i class="fas fa-magic"></i>
                            <span>自動</span>
                        </div>
                        <div class="missline-preset-card" data-preset="none">
                            <i class="fas fa-ban"></i>
                            <span>なし</span>
                        </div>
                    </div>
                </div>

                <div class="wizard-footer">
                    <button class="btn btn--secondary" id="btn-wizard-cancel-2" disabled>キャンセル</button>
                    <div class="wizard-footer-right">
                        <button class="btn btn--secondary" id="btn-wizard-step2-back">戻る</button>
                        <button class="btn btn--primary" id="btn-wizard-step2-next">次へ</button>
                    </div>
                </div>
            </div>

            <!-- Step 3: Grid Size & Confirm -->
            <div class="wizard-step hidden" id="wizard-step-3">
                <div class="wizard-step-title">グリッドサイズと確認</div>
                <div class="wizard-step-desc">設定を確認して作成してください</div>

                <div class="wizard-content">
                    <!-- Grid Size -->
                    <label class="label">グリッドサイズ（ブロック密度）</label>
                    <div class="grid-size-cards">
                        <div class="grid-size-card" data-size="small">
                            <div class="grid-preview grid-preview--small"></div>
                            <span>小</span>
                            <small>10px - 細かい</small>
                        </div>
                        <div class="grid-size-card selected" data-size="medium">
                            <div class="grid-preview grid-preview--medium"></div>
                            <span>中</span>
                            <small>30px - 標準</small>
                        </div>
                        <div class="grid-size-card" data-size="large">
                            <div class="grid-preview grid-preview--large"></div>
                            <span>大</span>
                            <small>50px - 大きい</small>
                        </div>
                    </div>
                    <p class="warning-text">
                        <i class="fas fa-info-circle"></i>
                        各ステージのグリッドサイズはステージ作成後に変更できません
                    </p>

                    <div class="form-divider"></div>

                    <!-- Summary -->
                    <div class="summary-panel">
                        <div class="summary-title">設定サマリー</div>
                        <div class="summary-row">
                            <span class="summary-label">ベースレイヤー:</span>
                            <span class="summary-value" id="summary-base-layer">-</span>
                        </div>
                        <div class="summary-row">
                            <span class="summary-label">ベースサイズ:</span>
                            <span class="summary-value" id="summary-base-size">-</span>
                        </div>
                        <div class="summary-row">
                            <span class="summary-label">追加領域:</span>
                            <span class="summary-value" id="summary-extra-area">-</span>
                        </div>
                        <div class="summary-row">
                            <span class="summary-label">キャンバスサイズ:</span>
                            <span class="summary-value" id="summary-canvas-size">-</span>
                        </div>
                        <div class="summary-row">
                            <span class="summary-label">グリッドサイズ:</span>
                            <span class="summary-value" id="summary-grid-size">-</span>
                        </div>
                    </div>
                </div>

                <div class="wizard-footer">
                    <button class="btn btn--secondary" id="btn-wizard-cancel-3" disabled>キャンセル</button>
                    <div class="wizard-footer-right">
                        <button class="btn btn--secondary" id="btn-wizard-step3-back">戻る</button>
                        <button class="btn btn--primary" id="btn-wizard-create">
                            <i class="fas fa-check"></i>
                            作成
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- File input for project loading -->
    <input type="file" id="file-input-project" accept=".hbp,.json" style="display:none">

    <!-- Scripts -->
    <script type="module">
        import { editor } from './editor/core/Editor.js?v=3';
        import { UIController } from './editor/ui/UIController.js?v=3';
        import { pixelToHex } from './shared/HexMath.js';

        // Initialize on DOM ready
        document.addEventListener('DOMContentLoaded', async () => {
            const mainCanvas = document.getElementById('mainCanvas');
            const overlayCanvas = document.getElementById('overlayCanvas');

            // Initialize editor (async - handles startup flow)
            await editor.init(mainCanvas, overlayCanvas);

            // Initialize UI controller
            const ui = new UIController(editor);
            ui.init();

            // Tab switching
            document.querySelectorAll('.panel-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.panel-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');

                    const tabId = tab.dataset.tab;
                    document.querySelectorAll('.panel-content').forEach(content => {
                        content.classList.toggle('hidden', content.id !== `tab-${tabId}`);
                    });
                });
            });

            // Canvas info updates
            overlayCanvas.addEventListener('mousemove', (e) => {
                const rect = overlayCanvas.getBoundingClientRect();
                const screenX = e.clientX - rect.left;
                const screenY = e.clientY - rect.top;
                const coords = editor.renderSystem.screenToCanvas(screenX, screenY);

                document.getElementById('cursor-pos-info').textContent =
                    `X: ${Math.round(coords.x)}, Y: ${Math.round(coords.y)}`;

                const gridSize = editor.renderSystem.gridSize;
                const hex = pixelToHex(coords.x, coords.y, gridSize);
                document.getElementById('hex-pos-info').textContent =
                    `Row: ${hex.row}, Col: ${hex.col}`;
            });

            // Update canvas size info
            editor.on('canvasSizeChanged', (size) => {
                document.getElementById('canvas-size-info').textContent =
                    `${size.width} x ${size.height}`;
            });

            // Menu items
            document.getElementById('menu-new')?.addEventListener('click', () => editor.newProject());
            document.getElementById('menu-toggle-grid')?.addEventListener('click', () => editor.toggleGrid());
            document.getElementById('menu-toggle-lines')?.addEventListener('click', () => editor.toggleLines());
            document.getElementById('menu-reset-view')?.addEventListener('click', () => editor.resetView());

            console.log('HexBreaker Editor ready');
        });
    </script>
</body>

</html>
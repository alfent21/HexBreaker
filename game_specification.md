# Hex Breaker Game Engine Specification

## 1. 概要 (Overview)

HTML5 Canvas + 物理演算を用いたブロック崩しゲームエンジン。
ヘックス（六角形）グリッドシステムを基盤とし、ウエポンシステム、ボス戦、パズル要素を統合している。

## 2. コアシステム (Core System)

### 2.1. ゲームループ (Game Loop)

`requestAnimationFrame` を用いた標準的な更新ループ。
- **Update**: デルタタイムを使用した各エンティティの状態更新。
- **Render**: キャンバスへの描画。
- **倍速モード**: 右クリックホールドで 2.0x ～ 3.0x 加速。

### 2.2. ステート管理 (State Management)

`GameState.js` によりゲームの進行状態を一元管理。

**States**: `title`, `playing`, `paused`, `gameover`, `clear`

**Data**:
- `score`: 現在スコア
- `lives`: 残機（デフォルト3）
- `gems`: 所持ジェム数
- `combo`: 現在のコンボ数
- `activeWeapons`: 発動中のウエポン状態

### 2.3. 入力システム (Input System)

`InputManager.js` による抽象化レイヤー。

| 入力 | アクション |
|------|------------|
| マウス移動 | パドル移動 |
| 左クリック | ボール発射 / MAGNET吸着 / GHOST透明化 / LASER発射 |
| 右クリック | 倍速モード |
| 数字キー 1-7 | ウエポン購入 |
| スペース | ボール発射 / LASER発射 |

### 2.4. 描画システム (Rendering System)

エディターとゲームで**同一の描画コード**（`shared/Renderer.js`）を使用し、見た目の統一を保証。

#### ブロック描画

- **エンボス効果**: 六角形の内側にハイライト（左上）とシャドウ（右下）
- **隙間**: ブロック間に2pxの隙間（radius - gap）
- **耐久表示**: 耐久値2以上の場合、中央に数字を表示
- **特殊アイコン**: ジェムドロップ、キー、ロック表示

#### ライン描画

エディターで配置した全ラインがゲーム画面でも表示される。

| タイプ | 線種 | ラベル | 用途 |
|--------|------|--------|------|
| collision | 実線 | なし | ボール反射壁 |
| paddle | 破線 | PADDLE | パドル移動軸 |
| missline | 長破線 | MISS LINE | ミス判定ライン |
| decoration | 実線 | なし | 装飾（判定なし） |

> **ゲーム時**: ラベルは非表示（`showLabels: false`）でクリーンな見た目を維持

#### ミスライン特殊効果（フェーズ2で実装予定）

仕様検討中:
- オーロラ発光エフェクト
- 亀裂表現
- 吸引パーティクル

## 3. 物理エンジン (Physics Engine)

### 3.1. 衝突判定 (Collision)

`CollisionSystem.js` が担当。

- **ヘックス判定**: 点と円の距離計算 + 頂点閾値 (`VERTEX_THRESHOLD`)。
- **線分判定**: `pointToLineDistance` による距離判定。
- **ミスライン**: 通常より広い判定範囲 (`hitThreshold * 2`) ですり抜け防止。

### 3.2. 反射ロジック (Reflection)

- **壁/ブロック**: 法線ベクトルに基づく完全弾性衝突。
- **頂点 (Vertex)**: 無限ループ防止のため、`RANDOM_ANGLE_RANGE` 分のランダム角度分散を適用。
- **パドル**: 衝突位置（中心からのオフセット）により反射角を ±60度変化させる。

### 3.3. ブロック誘導 (Block Guide)

壁反射時にボールをブロック方向へ誘導する補助システム。

**発動条件**:
- 壁（collision line）に反射した時
- 確率判定: `blockGuideProbability`（デフォルト50%）
- 角度制限: 通常反射角から ±`angleLimit`（デフォルト30°）以内

**対象**: プライマリボール（`balls[0]`）のみ

## 4. タップモード (Tap Mode)

パドルの代わりにタップ/クリックでボールを打ち返すモード。モバイル対応や異なるゲーム体験を提供。

### 4.1. 有効化条件

パドルラインの `paddleControl` プロパティが `'tap'` に設定されている場合、タップモードが有効になる。

### 4.2. タップエリア

ボールを打ち返すためにタップ可能な領域。

**範囲**: パドルラインの両側 `tapDistance` の距離
- ペアのミスラインがある場合: `pairOffset`（パドル-ミスライン間距離）を使用
- ない場合: `tapRange`（デフォルト40px）を使用
- フォールバック: 50px

**可視化**: 半透明の緑色で表示（ゲーム中）

### 4.3. ボール打ち返し条件

以下の全条件を満たす場合にボールを打ち返せる:

1. **クリック位置がタップエリア内** - タップエリア外のクリックは無視
2. **クリック位置から `hitRadius` 以内にボールがある** - デフォルト60px
3. **ボールが `wasHitInTapArea` フラグでマークされていない** - 同一エリア内での再ヒット防止
4. **ボールが attached 状態でない** - 発射前のボールは対象外

**重要**: ボール自体がタップエリア外にいても、上記条件を満たせば打ち返し可能。これは「ラケットを振る」イメージで、腕を伸ばせばエリア外のボールにも届く感覚を再現。

### 4.4. 仮想パドル反射

打ち返し時の反射ロジック:

1. **基本方向**: `normalSide`（左/右）方向にボールを飛ばす
2. **角度調整**: クリック位置とボール位置の接線方向オフセットで角度変化
   - ボールがクリック位置の右側 → 左方向に飛ぶ
   - ボールがクリック位置の左側 → 右方向に飛ぶ
3. **角度範囲**: 基本方向から最大±60°

### 4.5. 位置ベースクールダウン

同一タップエリア内でのボール再ヒットを防止:

1. ボールがタップでヒットされると `wasHitInTapArea = true`
2. ボールがタップエリアを離れると `wasHitInTapArea = false` にリセット
3. `wasHitInTapArea = true` の間はそのボールをヒット不可

### 4.6. エフェクト

| エフェクト | 内容 | 持続 |
|-----------|------|------|
| ラケット | クリック位置に円を描画（ヒット=緑、ミス=白） | 0.3秒 |
| フラッシュ | ヒットしたボールが黄色に発光 | 0.15秒 |
| テキスト | ジェム収集時に "+1" ポップアップ | 0.6秒 |

### 4.7. タップモード時の変更点

| 項目 | 通常モード | タップモード |
|------|-----------|-------------|
| パドル表示 | 表示 | 非表示 |
| パドル衝突判定 | 有効 | スキップ |
| ボール発射 | パドル位置から | パドルライン中点から |
| ジェム収集 | パドル接触 | タップ（hitRadius内） |
| 左クリック | MAGNET/GHOST/LASER | ボール打ち返し優先 |

### 4.8. エディター設定

パドルライン作成時に設定可能:

| プロパティ | 説明 | デフォルト |
|-----------|------|-----------|
| `paddleControl` | `'mouse'` or `'tap'` | `'tap'` |
| `normalSide` | 反射方向（`'left'`/`'right'`） | `'left'` |
| `tapRange` | タップエリア片側幅(px) | 40 |
| `hitRadius` | ボール選択最大距離(px) | 60 |
| `pairOffset` | ミスラインとの距離(px) | 50 |

---

## 5. エンティティ (Entities)

### 5.1. ボール (Ball)

- **プロパティ**: 座標(x,y), 速度(dx,dy), 半径(radius), 状態(attached/moving)
- **マルチボール**: 最大32個まで
- **プライマリボール**: `balls[0]` はブロック誘導の対象
- **タップモード用**: `wasHitInTapArea` フラグ、`flashTime` エフェクト

### 5.2. パドル (Paddle)

- **プロパティ**: 座標, 角度, 幅(縮小/通常/拡大)
- **軸移動**: 指定されたポリライン（パドル軸）上を移動
- **幅レベル**: Lv1(1.25x), Lv2(1.5x), Lv3(1.75x)

### 5.3. ブロック (Block)

| タイプ | 破壊 | 特徴 |
|--------|:----:|------|
| 通常 | ○ | 耐久値で破壊、確率でジェムドロップ |
| 確定ドロップ | ○ | 毎ヒットでジェム確定 |
| 無限ドロップ | ✕ | 破壊不可、毎ヒットでジェム |
| キーブロック | ○ | 破壊でリンク先ロック解除 |
| ロックブロック | 条件 | キー破壊まで無敵 |

**描画**: `shared/Renderer.drawHexBlock()` によりエンボス効果付きで描画（エディターと同一）

### 5.4. パワージェム (Power Gem)

- **ビジュアル**: 光る球体、ゴールドまたはシアン
- **挙動**: 上から下へ落下、パドル接触で取得
- **用途**: ウエポン購入の通貨

### 5.5. ボス (Boss)

クモ型の敵キャラクター。ボスステージに登場。

**移動**: ブロック「島」の範囲内を移動

**特殊能力**:
| 能力 | 効果 |
|------|------|
| ブロック再生 | 破壊されたブロックを再生成 |
| ボールキャッチ | ボールを捕まえて別方向へ投げる（速度2倍） |
| デバフ放出 | パドルに当たるとデバフ発動 |

**デバフ**:
| ID | 効果 | 持続 |
|:---|:-----|:----:|
| slow | パドル移動速度低下 | 10秒 |
| reverse | 操作左右反転 | 10秒 |
| short | パドル縮小 | 10秒 |
| disarm | ウエポン使用不可 | 10秒 |

## 6. ウエポンシステム (Weapon System)

パワージェムを消費してウエポンを購入・発動。

### 6.1. ウエポン一覧

| # | ID | コスト | 発動 | 持続 | 効果 |
|:-:|:---|:------:|:----:|:----:|------|
| 1 | slow | 1 | 即時 | 20秒 | ボール速度0.6倍 |
| 2 | wide | 2 | 即時 | 30秒 | パドル幅拡大（最大Lv3） |
| 3 | double | 2 | 即時 | 永続 | ボール追加（最大32個） |
| 4 | laser | 3 | ストック | 15秒 | 垂直レーザー発射 |
| 5 | shield | 4 | 即時 | 1回 | ミス防止バリア（最大3） |
| 6 | magnet | 4 | 即時 | 20秒 | 左クリックでボール吸着 |
| 7 | ghost | 4 | 即時 | 15秒 | 左クリックでブロックすり抜け |

### 6.2. 相互排他ルール

LASER / MAGNET / GHOST は左クリック操作を使用するため同時保持不可。

## 7. ゲームルール (Game Rules)

### 7.1. スコア

| アクション | 点数 |
|------------|-----:|
| ブロック ヒット | 10 |
| ブロック 破壊 | 50 |
| ボス 撃破 | 1000 |

**コンボ**: 2秒以内の連続破壊で倍率上昇（基本点 × コンボ数）

### 7.2. ライフ

- デフォルト: 3
- ボールがミスラインを通過で -1
- ライフ 0 でゲームオーバー
- コンティニュー可能（ジェム消滅）

### 7.3. クリア条件

- **通常ステージ**: 全破壊可能ブロックを破壊
- **ボスステージ**: ボス撃破（残ブロックは自動崩壊）

## 8. サウンド＆BGM (Sound & BGM)

### 8.1. 効果音

Gemini API で自動生成、キャッシュ再利用。

| イベント | 説明 |
|----------|------|
| block_hit | ブロックにヒット |
| block_destroy | ブロック破壊 |
| paddle_hit | パドルに反射 |
| gem_collect | ジェム取得 |
| weapon_activate | ウエポン発動 |
| boss_hit | ボスにヒット |
| boss_defeat | ボス撃破 |
| stage_clear | ステージクリア |
| game_over | ゲームオーバー |

### 8.2. BGM

ステージごとに設定可能。

| ID | 雰囲気 |
|:---|:-------|
| bgm_stage_01 | アップテンポ、明るい |
| bgm_stage_02 | ミドルテンポ、落ち着き |
| bgm_boss | 緊張感、激しい |
| bgm_clear | 勝利ファンファーレ |
| bgm_gameover | 残念系 |

## 9. 定数定義 (Constants)

`Constants.js` でゲームバランスを調整。

```javascript
// ボール
BALL_SPEED: 5.0,
MAX_BALLS: 32,

// パドル
PADDLE_WIDTH: 80,
PADDLE_EXPAND_LEVELS: [1.0, 1.25, 1.5, 1.75],

// ブロック誘導
BLOCK_GUIDE_PROBABILITY: 0.5,
BLOCK_GUIDE_ANGLE_LIMIT: 30,

// ジェム
POWER_GEM_CHANCE: 0.15,

// ライフ
DEFAULT_LIVES: 3,
MAX_LIVES: 5,

// コンボ
COMBO_TIMEOUT: 2000,  // ms

// ウエポン
WEAPON_COSTS: { slow: 1, wide: 2, double: 2, laser: 3, shield: 4, magnet: 4, ghost: 4 },
SLOW_DURATION: 20000,
EXPAND_DURATION: 30000,
LASER_DURATION: 15000,
MAGNET_DURATION: 20000,
GHOST_DURATION: 15000,
SHIELD_MAX_STOCK: 3,

// ボス
BOSS_DEFAULT_HP: 10,
BOSS_DEFAULT_SPEED: 2.0,
DEBUFF_DURATION: 10000
```

<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HexBreaker Game</title>
    <link rel="stylesheet" href="css/game.css">
</head>

<body>
    <div class="game-container">
        <!-- Header: HUD / „É°„ÉÉ„Çª„Éº„Ç∏Âàá„ÇäÊõø„Åà -->
        <header class="game-header">
            <!-- HUD (ÈÄöÂ∏∏ÊôÇ) -->
            <div class="header-hud" id="header-hud">
                <div class="hud-gems">
                    <span class="gem-icon">üíé</span>
                    <span class="gem-count" id="gem-count">0</span>
                </div>
                <div class="hud-score">
                    <span class="score-label">SCORE:</span>
                    <span class="score-value" id="score-value">0</span>
                </div>
                <div class="hud-lives" id="lives-display">
                    <span class="life-icon">‚ù§Ô∏è</span>
                    <span class="life-icon">‚ù§Ô∏è</span>
                    <span class="life-icon">‚ù§Ô∏è</span>
                </div>
            </div>
            <!-- „É°„ÉÉ„Çª„Éº„Ç∏ („Çπ„Çø„ÉÉ„ÇØË°®Á§∫) -->
            <div class="header-message-container" id="header-message-container">
                <div class="header-message-stack" id="header-message-stack">
                    <!-- Messages will be added here dynamically -->
                </div>
                <div class="header-message-actions">
                    <button class="header-message-copy-all" id="header-message-copy-all" title="ÂÖ®Â±•Ê≠¥„Çí„Ç≥„Éî„Éº">üìãÂÖ®ÈÉ®</button>
                </div>
            </div>
        </header>

        <!-- Main: „Ç≤„Éº„É†„Ç≠„É£„É≥„Éê„Çπ -->
        <main class="game-main">
            <canvas id="gameCanvas" width="1280" height="720"></canvas>

            <!-- Combo Display (mainÂÜÖ„ÅÆrelative) -->
            <div class="combo-display" id="combo-display">
                <div class="combo-count" id="combo-count">1</div>
                <div class="combo-label">COMBO</div>
            </div>
        </main>

        <!-- Footer: „Ç¶„Çß„Éù„É≥„Éë„Éç„É´ -->
        <footer class="game-footer">
            <div class="weapon-panel">
                <div class="weapon-slot" data-weapon="slow">
                    <span class="weapon-icon">üê¢</span>
                    <span class="weapon-name">SLOW</span>
                    <div class="weapon-cost">
                        <span class="weapon-cost-pip"></span>
                    </div>
                    <span class="weapon-key">[1]</span>
                </div>
                <div class="weapon-slot" data-weapon="wide">
                    <span class="weapon-icon">‚ÜîÔ∏è</span>
                    <span class="weapon-name">EXPD</span>
                    <div class="weapon-cost">
                        <span class="weapon-cost-pip"></span>
                        <span class="weapon-cost-pip"></span>
                    </div>
                    <span class="weapon-key">[2]</span>
                </div>
                <div class="weapon-slot" data-weapon="double">
                    <span class="weapon-icon">‚ö´‚ö´</span>
                    <span class="weapon-name">DBLE</span>
                    <div class="weapon-cost">
                        <span class="weapon-cost-pip"></span>
                        <span class="weapon-cost-pip"></span>
                    </div>
                    <span class="weapon-key">[3]</span>
                </div>
                <div class="weapon-slot" data-weapon="laser">
                    <span class="weapon-icon">üî´</span>
                    <span class="weapon-name">LASR</span>
                    <div class="weapon-cost">
                        <span class="weapon-cost-pip"></span>
                        <span class="weapon-cost-pip"></span>
                        <span class="weapon-cost-pip"></span>
                    </div>
                    <span class="weapon-key">[4]</span>
                </div>
                <div class="weapon-slot" data-weapon="shield">
                    <span class="weapon-icon">üõ°Ô∏è</span>
                    <span class="weapon-name">SHLD</span>
                    <div class="weapon-cost">
                        <span class="weapon-cost-pip"></span>
                        <span class="weapon-cost-pip"></span>
                        <span class="weapon-cost-pip"></span>
                        <span class="weapon-cost-pip"></span>
                    </div>
                    <span class="weapon-key">[5]</span>
                </div>
                <div class="weapon-slot" data-weapon="magnet">
                    <span class="weapon-icon">üß≤</span>
                    <span class="weapon-name">MGNT</span>
                    <div class="weapon-cost">
                        <span class="weapon-cost-pip"></span>
                        <span class="weapon-cost-pip"></span>
                        <span class="weapon-cost-pip"></span>
                        <span class="weapon-cost-pip"></span>
                    </div>
                    <span class="weapon-key">[6]</span>
                </div>
                <div class="weapon-slot" data-weapon="ghost">
                    <span class="weapon-icon">üëª</span>
                    <span class="weapon-name">GHST</span>
                    <div class="weapon-cost">
                        <span class="weapon-cost-pip"></span>
                        <span class="weapon-cost-pip"></span>
                        <span class="weapon-cost-pip"></span>
                        <span class="weapon-cost-pip"></span>
                    </div>
                    <span class="weapon-key">[7]</span>
                </div>
            </div>
        </footer>

        <!-- Game Overlays (position: fixed) -->
        <div class="game-overlay" id="overlay-gameover">
            <h1 class="game-overlay-title game-over">GAME OVER</h1>
            <p class="game-overlay-score">Score: <span id="final-score">0</span></p>
            <div class="game-overlay-buttons">
                <button class="btn btn--primary" id="btn-continue">„Ç≥„É≥„ÉÜ„Ç£„Éã„É•„Éº</button>
                <button class="btn" id="btn-quit">ÁµÇ‰∫Ü</button>
            </div>
        </div>

        <div class="game-overlay" id="overlay-clear">
            <h1 class="game-overlay-title stage-clear">STAGE CLEAR!</h1>
            <p class="game-overlay-score">Score: <span id="clear-score">0</span></p>
            <div class="game-overlay-buttons">
                <button class="btn btn--primary" id="btn-next">Ê¨°„ÅÆ„Çπ„ÉÜ„Éº„Ç∏</button>
            </div>
        </div>

        <!-- Pause Overlay -->
        <div class="game-overlay" id="overlay-pause">
            <div class="pause-menu">
                <h2 class="pause-title">PAUSED</h2>
                <div class="pause-log" id="pause-log">
                    <!-- Log entries populated by JS -->
                </div>
                <div class="pause-buttons">
                    <button class="btn btn--primary" id="btn-resume">ÂÜçÈñã</button>
                    <button class="btn" id="btn-pause-quit">ÁµÇ‰∫Ü</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { Game } from './game/Game.js';
        import { previewStorage } from './shared/PreviewStorage.js';

        // Initialize game on DOM ready
        document.addEventListener('DOMContentLoaded', async () => {
            const canvas = document.getElementById('gameCanvas');
            const game = new Game(canvas);

            // UI element references
            const scoreValue = document.getElementById('score-value');
            const gemCount = document.getElementById('gem-count');
            const livesDisplay = document.getElementById('lives-display');
            const comboDisplay = document.getElementById('combo-display');
            const comboCount = document.getElementById('combo-count');
            const overlayGameOver = document.getElementById('overlay-gameover');
            const overlayClear = document.getElementById('overlay-clear');
            const finalScore = document.getElementById('final-score');
            const clearScore = document.getElementById('clear-score');

            // UI update callbacks
            game.onScoreUpdate = (score) => {
                scoreValue.textContent = score.toLocaleString();
            };

            game.onLivesUpdate = (lives) => {
                livesDisplay.innerHTML = '‚ù§Ô∏è'.repeat(lives);
            };

            game.onGemsUpdate = (gems) => {
                gemCount.textContent = gems;
            };

            game.onComboUpdate = (combo) => {
                if (combo > 1) {
                    comboDisplay.classList.add('active');
                    comboCount.textContent = combo;
                } else {
                    comboDisplay.classList.remove('active');
                }
            };

            game.onWeaponUpdate = (availability) => {
                const slots = document.querySelectorAll('.weapon-slot');
                slots.forEach(slot => {
                    const weaponId = slot.dataset.weapon;
                    if (availability[weaponId]) {
                        slot.classList.add('can-afford');
                    } else {
                        slot.classList.remove('can-afford');
                    }
                });
            };

            game.onGameOver = (score) => {
                finalScore.textContent = score.toLocaleString();
                overlayGameOver.classList.add('active');
            };

            game.onStageClear = (score) => {
                clearScore.textContent = score.toLocaleString();
                overlayClear.classList.add('active');
            };

            // Weapon slot click handlers
            document.querySelectorAll('.weapon-slot').forEach(slot => {
                slot.addEventListener('click', () => {
                    const weaponId = slot.dataset.weapon;
                    game.input.onWeapon(weaponId);
                });
            });

            // Button handlers
            document.getElementById('btn-continue')?.addEventListener('click', () => {
                overlayGameOver.classList.remove('active');
                game.restart();
            });

            document.getElementById('btn-quit')?.addEventListener('click', () => {
                overlayGameOver.classList.remove('active');
                game.stop();
            });

            document.getElementById('btn-next')?.addEventListener('click', () => {
                overlayClear.classList.remove('active');
                game.restart(); // For now, just restart same stage
            });

            // Pause functionality
            const overlayPause = document.getElementById('overlay-pause');
            const pauseLog = document.getElementById('pause-log');

            function togglePause() {
                if (overlayPause.classList.contains('active')) {
                    // Resume
                    overlayPause.classList.remove('active');
                    game.resume();
                } else {
                    // Pause
                    game.pause();
                    populatePauseLog();
                    overlayPause.classList.add('active');
                }
            }

            function populatePauseLog() {
                const log = game.getMessageLog();
                pauseLog.innerHTML = '';

                if (log.length === 0) {
                    pauseLog.innerHTML = '<div class="pause-log-entry pause-log-entry--info">„É≠„Ç∞„Å™„Åó</div>';
                    return;
                }

                for (const entry of log.slice(-20)) { // Last 20 entries
                    const div = document.createElement('div');
                    div.className = `pause-log-entry pause-log-entry--${entry.type}`;

                    const time = new Date(entry.time);
                    const timeStr = time.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit', second: '2-digit' });

                    div.innerHTML = `<span class="pause-log-time">${timeStr}</span><span>${entry.text}</span>`;
                    pauseLog.appendChild(div);
                }
            }

            // Escape key handler
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    togglePause();
                }
            });

            document.getElementById('btn-resume')?.addEventListener('click', () => {
                overlayPause.classList.remove('active');
                game.resume();
            });

            document.getElementById('btn-pause-quit')?.addEventListener('click', () => {
                overlayPause.classList.remove('active');
                game.stop();
            });

            // Check for stage data from editor (via IndexedDB)
            try {
                const stageData = await previewStorage.load();
                if (stageData) {
                    game.loadStage(stageData);
                    await previewStorage.clear();
                } else {
                    // Load test stage for demonstration
                    game.loadTestStage();
                }
            } catch (e) {
                console.error('Failed to load stage data:', e);
                game.loadTestStage();
            }

            console.log('HexBreaker Game initialized');
        });
    </script>
</body>

</html>
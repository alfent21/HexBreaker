# HB Editor Specification

## 1. 概要 (Overview)
「Hex Breaker」用のステージ作成・編集ツール。
背景画像の上にヘックス（六角形）ブロックを配置し、物理演算用の壁（ライン）やパドル設定を行って、ステージデータ(.json)として出力する。
**注意**: 本仕様書は既存コードベース (`Editor.js`, `LineManager.js`, `RenderSystem.js`, `CanvasEvents.js`) のロジックを完全に反映し、再構築するためのものである。

## 2. システムコア (System Core)

### 2.1. キャンバス & グリッド

#### キャンバス構成

```
┌─────────────────────────────────────┐
│           Main Canvas               │  ← 背景・レイヤー・線分描画
├─────────────────────────────────────┤
│         Overlay Canvas              │  ← ホバー・選択・ツールUI
└─────────────────────────────────────┘
```

- **mainCanvas**: 背景、レイヤー、ブロック、線分を描画
- **overlayCanvas**: ホバーハイライト、選択範囲、ツールプレビューを描画（高速更新用）

#### キャンバスサイズ

**ステージ単位で固定**。ステージ作成時にベース画像から自動設定、または手動指定。

```javascript
stage.canvas: { width: 1280, height: 720 }  // ステージごとに異なるサイズ可
```

- ステージ作成後は変更不可（変更する場合はステージ再作成）
- 異なるアスペクト比のステージを同一プロジェクト内に混在可能

#### グリッドシステム（フラットトップ六角形）

**ステージ単位で固定**。ステージ作成時に選択し、以降変更不可。

**グリッドサイズ定義** (`GRID_SIZES`):

| サイズ名 | radius | width | height | verticalSpacing | 表示名 |
|----------|--------|-------|--------|-----------------|--------|
| `small` | 10 | 17.32 | 20 | 15 | 小(10px) |
| `medium` | 30 | 51.96 | 60 | 45 | 中(30px) |
| `large` | 50 | 86.60 | 100 | 75 | 大(50px) |

※ `width = √3 × radius`, `verticalSpacing = radius × 1.5`

> **重要**: グリッドサイズはブロックの配置密度を決定する。ステージ作成後に変更すると、配置済みブロックの座標が無効になるため、変更不可とする。

#### 座標変換アルゴリズム

**ヘックス座標 → ピクセル座標** (`hexToPixel`):
```javascript
offsetX = (row % 2 === 1) ? width / 2 : 0;  // 奇数行は半セル右にオフセット
x = col * width + offsetX + width / 2;
y = row * verticalSpacing + radius;
```

**ピクセル座標 → ヘックス座標** (`pixelToHex`):
1. 概算位置を計算
2. 近傍9セル（3×3）を探索
3. 最も中心が近いセルを選択

#### 隣接セルオフセット

行の偶奇によりオフセットが変化する:

```javascript
// row が偶数の場合
[[-1, -1], [-1, 0], [0, -1], [0, 1], [1, -1], [1, 0]]
// row が奇数の場合
[[-1, 0], [-1, 1], [0, -1], [0, 1], [1, 0], [1, 1]]
```

### 2.2. レイヤーシステム (Unified Layer System)

画像とブロックを統一的に扱う「レイヤー」構造を採用する。
**各ステージが独立したレイヤー群を持つ**（ステージ間でレイヤーは共有しない）。

> **設計方針**: 同じ画像を複数ステージで使用したい場合は、同じ画像ファイルを各ステージにインポートする。データの重複よりも管理のシンプルさを優先する。

#### レイヤーデータ構造

**画像レイヤー** (`type: 'image'`):
```javascript
{
    id: number,                // ステージ内での自動採番ID
    name: string,              // レイヤー名（ファイル名から生成）
    type: 'image',
    image: HTMLImageElement,   // 描画用画像要素
    imageData: string,         // Base64 dataURL（保存用）
    visible: boolean,          // 表示/非表示
    zIndex: number             // 描画順序（配列インデックス）
}
```

**ブロックレイヤー** (`type: 'block'`):
```javascript
{
    id: number,
    name: string,
    type: 'block',
    visible: boolean,
    zIndex: number,
    blocks: Map<string, BlockData>,  // key="row,col"
    sourceLayerId: number | null     // クリッピング参照先の画像レイヤーID
}
```

**ブロックデータ** (`BlockData`):
```javascript
{
    row: number,           // 行番号
    col: number,           // 列番号
    durability: number,    // 耐久値（1-10）
    color: string          // ブロック色 (#RRGGBB)
}
```

#### レイヤー操作API

| メソッド | 説明 |
|----------|------|
| `addLayer(name, image, imageData)` | 画像レイヤーを追加 |
| `addBlockLayer(name)` | 空のブロックレイヤーを追加 |
| `addLayerFromFile(file)` | ファイルから画像レイヤーを追加（非同期） |
| `getLayer(id)` | ID指定でレイヤーを取得 |
| `getAllLayers()` | 全レイヤーを配列で取得 |
| `removeLayer(id)` | レイヤーを削除 |
| `reorderLayer(fromIndex, toIndex)` | レイヤー順序を変更 |
| `moveUp(id)` / `moveDown(id)` | レイヤーを前面/背面へ移動 |
| `renameLayer(id, newName)` | レイヤー名を変更 |
| `setLayerVisibility(id, visible)` | 表示/非表示を切り替え |

#### 画像サイズ検証

画像レイヤー追加時に**ステージのキャンバスサイズ**との一致を検証:

```javascript
if (img.width !== stage.canvas.width || img.height !== stage.canvas.height) {
    reject(new Error(`画像サイズがステージサイズと一致しません`));
}
```

#### 差分レイヤー機能

**2つのレイヤーから差分を検出**:
1. `getLayerImageData(id)` で ImageData を取得
2. `DiffDetector.createDiffImage()` で差分画像を生成
3. `addLayerFromImageData()` で新規レイヤーとして追加

#### ブロック化 (Blockify)

画像レイヤーからブロックレイヤーを生成する機能。

**操作フロー**:
1. 画像レイヤーを選択
2. 右クリック → 「ブロック化」を選択
3. ダイアログで設定を指定
4. ブロックレイヤーが生成され、元画像とリンク

**ダイアログ設定項目**:
| 項目 | デフォルト | 説明 |
|------|:----------:|------|
| 耐久値 | 1 | 生成されるブロックの初期耐久値 |
| アルファ閾値 | 10 | この値以上のアルファ値を「非透明」とみなす |
| ピクセル比率 | 10% | ヘックス領域内の非透明率がこれ以上ならブロック配置 |

#### 差分ブロック生成 (Diff Blockify)

2枚の画像レイヤーの差分からブロックを生成する機能。

**操作フロー**:
1. レイヤーパネルで2つの画像レイヤーをチェック選択
2. 右クリック → 「差分ブロック生成」を選択
3. ダイアログで設定を指定
4. 差分領域にブロックレイヤーが生成

**ダイアログ設定項目**:
| 項目 | デフォルト | 説明 |
|------|:----------:|------|
| 耐久値 | 1 | 生成されるブロックの初期耐久値 |
| 差分閾値 | 30 | RGB差分がこの値以上を「差分あり」と判定 |
| ピクセル比率 | 10% | ヘックス領域内の差分率がこれ以上ならブロック配置 |

#### 画像リンク

ブロックレイヤーは1つの画像レイヤーをリンクできる。

**リンク設定**:
- ブロックレイヤー右クリック → 「画像リンク設定」
- プルダウンで対象画像レイヤーを選択
- `sourceLayerId` プロパティに格納

**リンク時の表示**:
- 通常ブロック: 単色 + **エンボス効果**（立体感）
- 画像リンクブロック: リンク画像 + **エンボス効果**（立体感）

**エンボス効果**:
- 六角形の**内側**にハイライト（左上）とシャドウ（右下）を描画
- 内側描画により隣接ブロックとの干渉を防止
- ブロックであることが視覚的に明確になる
- **エディターとゲームで同一の描画コード**（`shared/Renderer.js`）を使用

**ゲーム時の挙動**:
- ブロック破壊時、リンク画像の該当ヘックス領域を透明化
- 「画像が壊れていく」演出が可能

#### シリアライズ形式

```javascript
[
    {
        id: 1,
        name: "背景",
        type: "image",
        visible: true,
        zIndex: 0,
        imageData: "data:image/png;base64,..."
    },
    {
        id: 2,
        name: "服ブロック",
        type: "block",
        visible: true,
        zIndex: 1,
        blocks: [["0,0", {row:0, col:0, durability:1, color:"#64B5F6"}], ...],
        sourceLayerId: 1
    }
]
```

### 2.3. 線分（Line）システム
物理演算（衝突判定）用のライン定義。レイヤーとは独立して `LineManager` により管理される。
表示/非表示はグローバル設定 (`editor.showLines`) で切り替え可能。

#### 線分データ構造

```javascript
{
    id: 'line_' + timestamp + '_' + random5chars,  // 一意のID
    points: [{x, y}, ...],   // ポリライン頂点配列（2点以上）
    closed: boolean,         // true: ループ（始点と終点を結ぶ）
    type: 'collision' | 'missline' | 'paddle' | 'decoration',
    color: '#FFFF00',        // 表示色
    thickness: 3,            // 太さ (px)
    opacity: 1.0,            // 不透明度 (0.0 - 1.0)
    paddleControl: 'mouse-x',// パドル時のみ有効
    
    // ブロック誘導設定（collision タイプのみ有効、省略時はステージ設定を使用）
    blockGuide: {
        enabled: true,       // この壁でブロック誘導を有効にするか
        probability: null,   // 発動確率（null = ステージ設定を使用）
        angleLimit: null     // 誘導可能角度（null = ステージ設定を使用）
    }
}
```

#### 線分の種類と描画スタイル

| タイプ | 用途 | lineDash | ラベル | 物理判定 |
|--------|------|----------|--------|----------|
| `collision` | 壁（反射） | なし (実線) | なし | あり |
| `missline` | ミスライン | `[10, 5]` | "MISS LINE" (赤背景白文字) | あり (2倍閾値) |
| `paddle` | パドル軸 | `[5, 3]` | "PADDLE" (緑背景黒文字) | あり (反射角可変) |
| `decoration` | 装飾 | なし (実線) | なし | なし |

#### 線分描画仕様

**共通スタイル**:
```javascript
ctx.lineCap = 'round';
ctx.lineJoin = 'round';
ctx.strokeStyle = line.color;
ctx.lineWidth = line.thickness;
ctx.globalAlpha = line.opacity;
```

**選択中ハイライト**:
- 白色 (`#ffffff`) のアウトライン
- 太さ: `line.thickness + 4`
- 不透明度: 0.5

**頂点ハンドル** (選択中の線分):

| 状態 | 色 | サイズ |
|------|-----|--------|
| 通常 | `#ffff00` (黄) | 8px |
| ホバー | `#00ffff` (シアン) | 8px |
| ドラッグ中 | `#ff6600` (オレンジ) | 8px |

**ラベル描画** (missline, paddle):
- 位置: 最初のセグメントの中点、Y-25px
- フォント: `bold 14px sans-serif`
- サイズ: テキスト幅 + padding(4px) × 2, 高さ 18px

#### 線分操作仕様

**描画フロー**:
1. 左クリック: 最初の頂点を配置、描画開始
2. 左クリック (継続): 頂点を追加
3. 始点を再クリック: ループとして確定 (`closed: true`)
4. 同じ点を再クリック: 開いた線分として確定
5. ダブルクリック: 描画を確定
6. Escape: 描画をキャンセル

**編集フロー**:
1. 線分をクリック: 選択（頂点ハンドルが表示される）
2. 頂点をドラッグ: 頂点を移動
3. セグメント上でダブルクリック: 新しい頂点を挿入
4. 頂点を右クリック: 頂点を削除（2点以上残る場合のみ）
5. 線分が1点以下になる: 線分自体を削除

**スナップ機能**:
- ヘックス頂点へのスナップ
- 画面端へのスナップ（left, right, top, bottom）
- 既存線分の頂点へのスナップ

#### 物理挙動仕様

1.  **壁 (Collision)**:
    - **反射**: 入射角＝反射角（法線ベクトル基準）
    
2.  **パドル (Paddle)**:
    - **反射角可変**: パドル中心からの距離 (-1.0 ~ 1.0) を ±60度にマッピング
    - **操作設定 (paddleControl)**:
        - `mouse-x` / `mouse-y`: マウス座標にリニア追従
        - `mouse-x-inv` / `mouse-y-inv`: マウス座標に反転追従
        - `key-x` / `key-y`: キーボード（矢印/WASD）で移動
        - `key-x-inv` / `key-y-inv`: キーボード反転操作
        - `auto`: AIによる自動操作

3.  **ミスライン (Missline)**:
    - **判定距離**: `hitThreshold * 2`（すり抜け防止）
    - **エフェクト**: ボール吸い込み演出
    - **ゲームビジュアル**: 亀裂表現、オーロラ発光、吸引パーティクル

4.  **装飾 (Decoration)**:
    - 物理演算から完全に除外

### 2.4. ブロック操作システム (Block Operations)

`BlockManager` クラスにより管理。アクティブなブロックレイヤーに対して操作を行う。

#### ブロックキー形式

```javascript
getKey(row, col) {
    return `${row},${col}`;  // "0,5" 形式
}
```

#### ブラシツール

**ブラシサイズ**:

| サイズ | 範囲 | 説明 |
|--------|------|------|
| `S` | 中心1セルのみ | 精密配置 |
| `M` | 中心 + 隣接6セル | 標準ブラシ |
| `L` | 中心 + 隣接6セル + 2段階隣接 | 広範囲ブラシ |

**操作**:
- 左クリック/ドラッグ: ブラシ範囲にブロック配置
- Shift + クリック: 消しゴムモード（一時切替）

#### 消しゴムツール

- ブラシと同サイズで範囲内のブロックを削除
- ホバー時は赤色 (`#ff4444`) でハイライト

#### 塗りつぶしツール

**アルゴリズム**: BFS（幅優先探索）

```javascript
1. クリック位置のブロック耐久値を取得（targetDurability）
2. 空欄クリックは無視（既存ブロックの変更専用）
3. 同じ耐久値の隣接ブロックを探索
4. 新しい耐久値（currentDurability）に変更
```

#### 円形配置ツール

- 中心点をクリック → ドラッグで半径決定
- 円形領域内のすべてのヘックスにブロック配置
- プレビュー: 青色破線 (`#0078d4`, lineDash `[5, 5]`)

#### 選択範囲ツール

- 矩形選択: ドラッグで範囲指定
- 範囲内のヘックス中心座標をチェック
- 選択されたヘックスは緑色 (`#00ff00`) でハイライト
- `selectedHexes: Set<string>` に格納

**選択操作**:
- Enter / 塗りつぶしボタン: 選択範囲にブロック配置
- Delete / 削除ボタン: 選択範囲のブロック削除
- Escape: 選択解除

#### デフォルト値

```javascript
currentDurability: 1            // 耐久値
currentBlockColor: '#64B5F6'    // ブロック色（Material Design Blue 300）
brushSize: 'M'                  // ブラシサイズ
```

### 2.5. ボール挙動と物理仕様 (Physics & Ball Behavior)
エディタ出力データは `game/physics/CollisionSystem.js` の仕様に準拠する。

#### 反射ルール (Reflection Rules)
1.  **基本反射**: 壁 (`collision`) との衝突は、法線ベクトルに基づく完全弾性衝突。
2.  **頂点反射 (Vertex Hit)**:
    - ヘックスや線分の「角」に当たった場合、`RANDOM_ANGLE_RANGE` に基づくランダムな角度分散が発生する。
    - これにより無限ループパターンを防止する。
3.  **パドル反射**:
    - **角度制御**: パドル中心からの距離 (-1.0 ~ 1.0) を ±60度 (`Math.PI/3`) の反射角にマッピング。
    - プレイヤーが意図的に反射角を操作できる仕様。

#### 判定精度
- **Vertex Threshold**: 頂点判定には追加の閾値 (`VERTEX_THRESHOLD`) があり、角への当たり判定は少し広めに取られる。
- **Miss Line Check**: ミスラインはボール半径＋線分太さの2倍の距離で判定され、高速移動時のすり抜けを防ぐ。

#### ブロック誘導 (Block Guide)

壁反射時にボールをブロック方向へ誘導する補助システム。
ゲームが理不尽に長引くことを防ぎ、プレイヤーのストレスを軽減する。

**発動条件**:
- 壁（`collision` タイプのライン）に反射した時
- 確率判定: `Math.random() < blockGuideProbability`
- **角度制限**: 通常反射角から ±30° 以内にブロックが存在すること

**角度制限の詳細**:
```
        通常の反射方向
              ↑
         ╲    │    ╱
      -30° ╲  │  ╱ +30°
             ╲│╱
    ─────────●─────────  壁
              │
              ○ ボール（入射）
```
- 通常の反射角を計算（入射角＝反射角）
- その反射方向を中心に ±`blockGuideAngleLimit`（デフォルト30°）の扇形範囲を設定
- 範囲内にブロックがあれば、最寄りのブロックへ誘導
- **範囲外にしかブロックがない場合**: 誘導しない（通常反射のまま）

**効果**:
- ボールの進行方向を対象ブロックに向ける
- 速度（magnitude）は維持したまま方向のみ変更
- 自然な反射に見える範囲でのみ誘導が発動

**対象**:
- **プライマリボール（`balls[0]`）のみ**
- マルチボール時、サブボールには適用されない（純粋な物理反射）

**設定階層**:

1. **ステージ設定**（デフォルト値）
```javascript
// ステージメタデータ
{
    blockGuide: {
        enabled: true,         // ステージ全体で有効/無効
        probability: 0.5,      // 発動確率 50%
        angleLimit: 30         // 誘導可能角度 ±30°
    }
}
```

2. **線分ごとの設定**（オーバーライド）
```javascript
// 線分データ内
{
    blockGuide: {
        enabled: true,         // この壁で有効/無効
        probability: 0.8,      // この壁専用の確率（省略時はステージ設定）
        angleLimit: 45         // この壁専用の角度（省略時はステージ設定）
    }
}
```

**優先順位**: 線分設定 > ステージ設定 > デフォルト値

### 2.6. アイテム・ウエポンシステム (Item & Weapon System)

アイテムは「通貨」として機能し、収集したアイテム数に応じてウエポンと交換できる。
ウエポン自体がアイテムとして出現することはない。

#### A. パワージェム (Power Gem)

ゲーム内で収集できる唯一のアイテムタイプ。

**ビジュアル**:
- 光る球体（ブロックと明確に区別できるデザイン）
- 発光エフェクト付き（輝き、パルスアニメーション）
- 色: ゴールドまたはシアン系

**出現条件**:

| ブロックタイプ | 破壊 | ドロップ | 備考 |
|----------------|:----:|----------|------|
| 通常ブロック | ○ | 確率（デフォルト15%） | 破壊時に判定 |
| 確定ドロップブロック | ○ | 毎ヒット確定 | 耐久値分だけドロップ |
| 無限ドロップブロック | ✕ | 毎ヒット確定 | 破壊不可、クリア判定対象外 |

**ブロックデータ構造**:
```javascript
// 通常ブロック（gemDrop省略 = 確率ドロップ）
{ row: 5, col: 10, durability: 1, color: "#64B5F6" }

// 確定ドロップブロック
{ row: 5, col: 10, durability: 3, color: "#FFD700", gemDrop: "guaranteed" }

// 無限ドロップブロック（durability無視、破壊されない）
{ row: 5, col: 10, color: "#FF00FF", gemDrop: "infinite" }

// キーブロック（破壊するとリンク先のロックが解除）
{ 
    row: 5, col: 10, durability: 1, color: "#FFD700",
    blockType: "key",
    keyId: "key_001"  // ユニークなキーID
}

// ロックブロック（対応するキーが破壊されるまで破壊不可）
{ 
    row: 6, col: 10, durability: 2, color: "#888888",
    blockType: "lock",
    linkedKeyId: "key_001"  // 対応するキーID
}
```

**ロック＆キーブロック仕様**:

| タイプ | 見た目 | 破壊 | 備考 |
|--------|--------|:----:|------|
| **キーブロック** | 🔑 鍵マーク | ○ | 破壊でリンク先ロック解除 |
| **ロックブロック** | 🔒 南京錠マーク | 条件付き | キー破壊まで無敵 |

**リンク設定**:
- 1つのキーに複数のロックをリンク可能
- キーブロック破壊 → リンクされた全ロックが通常ブロック化
- ロックブロックはキー解除前もボールを反射する（透過しない）
- ロック解除後は設定された `durability` で破壊可能

**ステージ設定**:
```javascript
{
    powerGemChance: 0.15  // 通常ブロックの出現確率（デフォルト15%）
}
```

**挙動**:
- 上から下へゆっくり落下
- パドル接触で取得
- 取得時: スコア加算 + 所持ジェム数 +1
- 画面外（下）で消滅

**所持数の持ち越し**:
- **デフォルト**: ステージクリア後も持ち越し
- **設定可能**: ステージごとにリセットするオプション（`resetGemsOnClear: boolean`）

#### B. ウエポン交換システム

**交換UI**:
- ゲーム画面の端（右側または下部）にウエポンパネルを常時表示
- 各ウエポンのアイコン、必要ジェム数、現在の状態を表示
- ジェム数が足りているウエポンはハイライト
- **数字キー（1-6）**: 即座に交換・発動
- **右クリック**: コンテキストメニューを開いて選択

**交換ルール**:
- 所持ジェム数 ≥ 必要コスト → 交換可能
- 交換時にジェムを消費
- 同一ウエポンの重複購入可否はウエポンごとに異なる

#### C. ウエポン詳細 (Weapon Details)

| # | ID | 名前 | コスト | 発動 |
|:-:|:---|:-----|:------:|:-----|
| 1 | **slow** | SLOW | 1 | 即時 |
| 2 | **wide** | EXPAND | 2 | 即時 |
| 3 | **double** | DOUBLE | 2 | 即時 |
| 4 | **laser** | LASER | 3 | ストック |
| 5 | **shield** | SHIELD | 4 | 即時 |
| 6 | **magnet** | MAGNET | 4 | 即時 |
| 7 | **ghost** | GHOST | 4 | 即時 |

---

**① SLOW** (コスト: 1)
- **発動**: 購入で即座にボール速度が0.6倍に低下
- **持続**: 20秒
- **再購入**: 効果時間を延長（+20秒）
- **上限**: なし（時間延長は無制限）

---

**② EXPAND** (コスト: 2)
- **発動**: 購入で即座にパドル幅が拡大
- **持続**: 30秒
- **再購入**: さらに大きく + 時間延長（3段階まで）
  - Lv1: 1.25倍
  - Lv2: 1.5倍
  - Lv3: 1.75倍（最大）
- **上限**: Lv3以降はグレーアウト（購入不可）

---

**③ DOUBLE** (コスト: 2)
- **発動**: 購入で即座にボールが1つ追加（分裂）
- **持続**: 永続（ボールをロストするまで）
- **再購入**: さらにボール追加
- **上限**: 32個（処理負荷考慮）
- **プライマリボール**: 
  - 一番古い（`balls[0]`）ボールがプライマリ
  - **ブロック誘導**がプライマリのみに適用される（後述）
  - 他のボールは純粋な物理反射のみ

---

**④ LASER** (コスト: 3)
- **発動**: 購入でストック（すぐには発射しない）
- **操作**: スペースキー or 左クリックで発射
- **挙動**: 
  - パドル位置から垂直方向にレーザーを展開
  - 照準操作なし（発射した瞬間の位置から固定）
  - レーザーらしい演出（ビーム、光線エフェクト）
- **レベル制**: 追加購入でレベルアップ（最大Lv3）
  - Lv1: 1本（1ダメージ）
  - Lv2: 2本（各1ダメージ）
  - Lv3: 3本（中央2ダメージ、左右1ダメージ）
- **持続**: 発射から15秒 or 弾数消費
- **制限**: MAGNET保持中はグレーアウト（購入不可）

---

**⑤ SHIELD** (コスト: 4)
- **発動**: 購入で即座にミスライン手前に床バリアを展開
- **持続**: ボールが1回接触するまで
- **再購入**: 追加のシールドをストック
- **上限**: 3つまで（以降はグレーアウト）
- **挙動**: ボール接触でシールド1つ消費、ボールを跳ね返す

---

**⑥ MAGNET** (コスト: 4)
- **発動**: 購入で即座に効果開始
- **持続**: 20秒
- **操作**:
  - **左クリック（押し続け）**: 近くのボールを引き寄せ、パドルに吸着
  - **左クリック（離す）**: 吸着中のボールを放つ（発射）
- **挙動**: 
  - 複数ボールがある場合、最も近いボールを引き寄せる
  - 吸着中はボールがパドルに追従
- **制限**: LASER保持中はグレーアウト（購入不可）

---

**⑦ GHOST** (コスト: 4)
- **発動**: 購入で即座に効果開始
- **持続**: 15秒
- **操作**:
  - **左クリック（押し続け）**: プライマリボールが半透明化、ブロックをすり抜ける
  - **左クリック（離す）**: 通常状態に戻る
- **挙動**: 
  - プライマリボール（`balls[0]`）のみに適用
  - ブロックをすり抜ける（ダメージなし）
  - **壁（collision line）はすり抜けない**
  - **パドルもすり抜けない**
  - **ミスラインもすり抜けない**
- **ビジュアル**: 半透明 + 幽霊のようなエフェクト
- **制限**: MAGNET・LASER保持中はグレーアウト（左クリック操作が競合）

---

**相互排他ルール**:
- LASER・MAGNET・GHOST は左クリック操作を使用するため同時保持不可
- いずれか1つを保持中は、他の2つはグレーアウト

#### D. UI表示

**ジェム所持数**:
- 画面上部または右上に常時表示
- アイコン + 数字（例: 💎 5）

**ウエポンパネル**:
```
┌──────────────────────────┐
│ 💎 5                     │  ← 現在のジェム数
├──────────────────────────┤
│ [1] SLOW     ●   (1)     │  ← 購入可能
│ [2] EXPAND   ●●  (2)     │  ← 購入可能
│ [3] DOUBLE   ●●  (2)     │  ← 購入可能
│ [4] LASER    ●●● (3)     │  ← 購入可能
│ [5] SHIELD   ●●●●(4)     │  ← ジェム不足（グレーアウト）
│ [6] MAGNET   ●●●●(4)     │  ← ジェム不足
└──────────────────────────┘
```

**アクティブウエポン表示**:
- 発動中のウエポンはアイコン + 残り時間ゲージを表示
- 複数ウエポン同時発動可能

#### E. ゲーム設定（ステージ/プロジェクト単位）

```javascript
{
    powerGemChance: 0.15,         // ブロック破壊時の出現確率
    resetGemsOnClear: false,      // ステージクリア時にジェムリセット
    weaponCosts: {                // ウエポンコスト（エディタで設定可能）
        laser: 3,
        wide: 2,
        shield: 4,
        double: 2,
        magnet: 4,
        slow: 1
    },
    allowedWeapons: ['laser', 'wide', 'shield', 'double', 'magnet', 'slow']
}
```

### 2.7. ゲーム進行操作 (Game Controls)
- **倍速進行 (Fast Forward)**:
    - **操作**: マウス右クリック（ホールド中は時間経過が加速）。
    - **用途**: 残りブロックがわずかな場合や、ボールの移動待ち時間を短縮するため。
    - **仕様**: 物理演算およびゲームループの更新頻度を上げる。加速倍率は 2.0x ～ 3.0x 程度。

### 2.8. ゲームルール (Game Rules)

#### スコアシステム

**基本スコア**:
| アクション | 点数 |
|------------|-----:|
| ブロック ヒット | 10 |
| ブロック 破壊 | 50 |
| ボス 撃破 | 1000 |

**連続破壊ボーナス（コンボ）**:
- 一定時間内（2秒）にブロックを連続破壊するとコンボ発生
- コンボ倍率: 基本点 × コンボ数
- コンボ上限: なし
- ジェム取得ではスコア加算なし
- クリアボーナス: ステージ設定で設定可能

#### ライフ＆ゲームオーバー

**残機**:
- デフォルト: 3
- ステージ設定で変更可能（`initialLives`）
- ボールがミスラインを通過でライフ -1
- ライフ 0 でゲームオーバー

**コンティニュー**:
- ゲームオーバー時にコンティニュー可能
- **ペナルティ**: 収集したジェムはすべて消滅
- スコアは維持

#### ステージクリア条件

**通常ステージ**:
- すべての破壊可能ブロックを破壊
- 無限ドロップブロック、ロック解除前のロックブロックは対象外

**ボスステージ**:
- ボスを撃破
- ボス撃破時、残存ブロックは自動崩壊（連鎖破壊演出）

### 2.9. ボスシステム (Boss System)

ボスステージに登場する敵キャラクター。

#### ボス基本仕様

**外見**: クモのような敵キャラ

**移動**:
- ブロックが存在する範囲内を移動
- 移動パターン: ランダム / 追尾 / パトロール（設定可能）

**撃破条件**:
- ボスにボールを一定回数当てる（`bossHitPoints`）
- ボス撃破でステージクリア

#### ボス特殊能力

エディタで能力を設定可能。複数の能力を持つボスも作成可能。

**① ブロック再生 (Block Regenerate)**
- 破壊されたブロックを再生成
- 元々存在しなかった場所には生成不可
- クールダウン: 5秒（設定可能）

**② ボールキャッチ (Ball Catch)**
- 視界内のボールをキャッチ
- 別の方向へ投げる
- 投げられたボールは壁に当たるまで速度2倍

**③ デバフアイテム放出 (Debuff Drop)**
- パドル方向に「フン」のようなアイテムを落とす
- パドルに当たるとデバフ効果発動

#### デバフ効果

| ID | 名前 | 効果 | 持続時間 |
|:---|:-----|:-----|:--------:|
| **slow** | SLOW | パドルの移動速度が低下 | 10秒 |
| **reverse** | REVERSE | 操作が左右反転 | 10秒 |
| **short** | SHORT | パドルが短くなる（0.5倍） | 10秒 |
| **disarm** | DISARM | ウエポンが使用不可 | 10秒 |

**デバフ挙動**:
- パドルに当たると即発動
- 複数デバフの同時発動可能
- 同一デバフの重複は時間延長

#### ボス設定（ステージメタデータ）

```javascript
{
    boss: {
        enabled: true,
        hitPoints: 10,              // 撃破に必要なヒット数
        speed: 2.0,                 // 移動速度
        movementPattern: "random",  // random | chase | patrol
        abilities: ["regenerate", "catch", "debuff"],
        regenerateCooldown: 5000,   // ms
        debuffTypes: ["slow", "reverse", "short", "disarm"]
    }
}
```

### 2.10. サウンド＆BGM (Sound & BGM)

#### 効果音 (Sound Effects)

ゲームイベントに応じた効果音を再生する。

**自動生成方式**:
- Gemini API を使用して効果音を自動生成
- 生成されたサウンドはキャッシュして再利用
- 将来的にカスタム効果音のアップロードも対応予定

**イベントと効果音**:
| イベント | 説明 |
|----------|------|
| `block_hit` | ブロックにヒット |
| `block_destroy` | ブロック破壊 |
| `paddle_hit` | パドルに反射 |
| `wall_hit` | 壁に反射 |
| `gem_collect` | ジェム取得 |
| `weapon_activate` | ウエポン発動 |
| `laser_fire` | レーザー発射 |
| `boss_hit` | ボスにヒット |
| `boss_defeat` | ボス撃破 |
| `debuff_hit` | デバフ被弾 |
| `life_lost` | ライフ減少 |
| `stage_clear` | ステージクリア |
| `game_over` | ゲームオーバー |

#### BGM (Background Music)

ステージごとにBGMを設定可能。

**エディタ設定**:
- ステージ設定ダイアログ内で BGM ファイルを選択
- ファイル形式: MP3, OGG, WAV
- プルダウンでデフォルト曲から選択 or カスタムファイル指定

**デフォルトBGM**:
| ID | 名前 | 雰囲気 |
|:---|:-----|:-------|
| `bgm_stage_01` | Stage Theme 1 | アップテンポ、明るい |
| `bgm_stage_02` | Stage Theme 2 | ミドルテンポ、落ち着き |
| `bgm_boss` | Boss Theme | 緊張感、激しい |
| `bgm_clear` | Clear Jingle | 短い勝利ファンファーレ |
| `bgm_gameover` | Game Over | 短い残念系 |

**ステージ設定**:
```javascript
{
    bgm: {
        id: "bgm_stage_01",      // デフォルト曲ID または
        customFile: null,        // カスタムファイルパス
        volume: 0.7,             // 音量 (0.0 - 1.0)
        loop: true               // ループ再生
    }
}
```

## 3. UI仕様 (User Interface)

画面は以下のエリアに分割される。

### 3.1. メニューバー (Top)
- **ファイル**: 新規作成、開く、保存、エクスポート
- **編集**: 元に戻す、やり直す
- **表示**: グリッド表示切替、線分表示切替

### 3.2. ツールバー (Top)
頻繁に使用するアクションへのショートカット。
- 新規作成、開く、保存
- Undo / Redo
- **ステージ選択**: 現在編集中のステージをプルダウンで切り替え
- ズーム表示（100%）、ズームイン/アウトボタン

> **注**: グリッドサイズ選択はステージ作成時にのみ設定可能。ツールバーには表示されない。

### 3.3. 左サイドパネル (Left Panel)

#### A. ツールパレット
描画・編集用ツール。
- **選択 (Select)**: レイヤーやオブジェクトの選択・移動。
- **ブラシ (Brush)**: ブロック描画（ブロックレイヤー選択時）。
- **消しゴム (Eraser)**: ブロック削除。
- **塗りつぶし (Fill)**: 閉領域のブロック充填。
- **ライン (Line)**: 物理ラインの描画。
- **スポイト (Eyedropper)**: 色や設定の取得。
- **ハンド (Hand)**: キャンバススクロール。
- **ズーム (Zoom)**: 拡大縮小。
- **プレビュー (Preview)**: 別ウィンドウでゲームプレビューを起動。

#### B. ブロック右クリックメニュー (Block Context Menu)

ブロックを右クリックした際に表示されるコンテキストメニュー。

**基本設定**:
- **耐久値変更**: 1〜9 のサブメニュー
- **色変更**: カラーピッカー

**ドロップタイプ**:
- **通常** (デフォルト): 確率ドロップ
- **確定ドロップ**: 毎ヒットでジェム
- **無限ドロップ**: 破壊不可、毎ヒットでジェム

**ロック＆キー設定**:
- **キーに設定**: このブロックをキーブロックに変換
- **ロックに設定**: キーブロックが存在しない場合はグレーアウト
  - キーブロック選択プルダウン表示（1つの場合は即時確定）
- **解除**: 通常ブロックに戻す

**ボス配置**:
- **ここにボスを配置**: このブロックを中心にボスを配置
  - ボスは隣接ブロック「島」の範囲内で移動可能
  - 再生能力もこの島のブロックのみ対象

#### C. ボス右クリックメニュー (Boss Context Menu)

配置済みのボス（クモ）を右クリックした際に表示。

- **HP設定**: 撃破に必要なヒット数
- **移動速度**: 数値入力
- **移動パターン**: ランダム / 追尾 / パトロール
- **特殊能力**: チェックボックスで複数選択
  - ブロック再生 (クールダウン設定)
  - ボールキャッチ
  - デバフ放出 (デバフ種類選択)
- **削除**: ボスを削除

#### D. 線分設定 (Line Properties)
線分ツール使用時、および既存線分選択時に表示。
- **種類**: 壁 / パドル / ミス のラジオボタン
- **色**: カラーピッカー (パドル・ミス選択時は無効/固定)
- **太さ**: 数値入力 (px) (パドル・ミス選択時は無効/固定)
- **不透明度**: スライダー (パドル・ミス選択時は無効/固定)
- **パドル操作**: マウス追従(X/Y), 自動 などの選択 (パドル選択時のみ有効)

### 3.4. メインキャンバス (Center)
- 編集領域。
- **ズーム/パン機能 (必須実装)**:
    - ホイール回転: 拡大・縮小 (Zoom In/Out)。カーソル位置中心。
    - スペースキー+ドラッグ / 中クリックドラッグ: 視点移動 (Pan)。
    - **Transform管理**: キャンバスの `scale` と `translate` を管理し、マウスイベント座標を適切に逆変換してグリッド判定を行うこと。
- 常にヘックスグリッドをオーバーレイ表示可能。

### 3.5. 右サイドパネル (Right Panel)

#### A. レイヤーパネル (Layer List)
- レイヤー一覧をリスト表示。
- ドラッグ＆ドロップでの並べ替え。
- 各行に「表示/非表示」「ロック」「削除」アイコン。
- **アクティブレイヤー**: クリックで選択されたレイヤー（編集対象）。
- **右クリックメニュー**: レイヤー複製、結合、ブロック化、プロパティ設定。

> **レイヤー自動切替**: 画像レイヤーを選択した状態でブロック操作（ブラシ、消しゴム、塗りつぶし）を行おうとすると、確認ダイアログが表示される。「レイヤー「○○」を選択して編集しますか？」で「OK」を選択すると、最寄りのブロックレイヤー（選択中の画像レイヤーより上層にあるブロックレイヤー、なければ下層を探索）に自動切替してから操作を実行する。ブロックレイヤーが存在しない場合は警告メッセージを表示し、操作を中止する。

#### B. レイヤープロパティ (Layer Properties - Contextual)
選択中のレイヤー種別に応じて内容が変化する。
- **共通**: 名前変更、不透明度、描画モード、表示/ロック切替。
- **画像レイヤー選択時**:
    - 座標 (`x`, `y`)、サイズ (`w`, `h`)、回転 (`rotation`)。
    - 「ブロック化 (Blockify)」実行ボタン。
    - 「差分ブロック化 (Diff)」実行ボタン（対象レイヤー選択UI）。
- **ブロックレイヤー選択時**:
    - グリッド設定（サイズ、間隔）。
    - リンクされている画像ソースの表示。
    - 「全消去」「最適化」などのコマンド。

#### C. ステージ管理パネル (Stage Manager)

**新規ステージ作成**:

「+新規ステージ」ボタンをクリックすると、以下のダイアログが表示される:

```
┌──────────────────────────────────────────┐
│ 新規ステージ作成                           │
├──────────────────────────────────────────┤
│ ステージ名: [_________________]           │
│                                          │
│ ベース画像: [ファイル選択]                 │
│   → 画像サイズ自動取得: 1280 x 720 px     │
│                                          │
│ または手動設定:                           │
│   幅: [1280] px  高さ: [720] px          │
│                                          │
│ ▼ グリッドサイズ（ブロック密度）           │
│   ○ 小 (10px) - 細かいブロック            │
│   ● 中 (30px) - 標準                     │
│   ○ 大 (50px) - 大きいブロック            │
│                                          │
│ ⚠ グリッドサイズは作成後に変更できません    │
│                                          │
│ [キャンセル]            [作成]            │
└──────────────────────────────────────────┘
```

> **重要**: グリッドサイズとキャンバスサイズはステージ作成時にのみ設定可能。作成後は変更不可（変更したい場合はステージを削除して再作成）。

**ステージ一覧**:
- 登録済みステージをリスト表示
- クリック: 編集対象として選択（キャンバスにロード）
- ドラッグ＆ドロップ: ステージ順序変更

**ステージ右クリックメニュー**:
- **設定 (Settings)**: ステージメタデータ編集ダイアログを開く
  - 残機、クリアボーナス、ジェム確率
  - ブロック誘導設定
  - ボス設定
  - BGM、背景色
- **複製**: ステージを複製（レイヤーも複製）
- **削除**: ステージを削除
- **エクスポート**: このステージのみ出力

### 3.6. ダイアログ・モーダル (Dialogs)
- **環境設定 (Preferences)**:
    - グリッドのデフォルト色・サイズ、操作感度など。
- **ステージ設定 (Stage Settings)**:
    - 上記ステージメタデータの詳細編集。
- **エクスポート設定 (Export)**:
    - 出力ファイル名、圧縮有無、対象ステージ選択。

### 3.8. メッセージパネル (Message Panel)

エディタ最下部に配置されるメッセージ表示領域。

**エディタ表示**:
- **行数**: 3行表示
- **スクロール**: 可能（過去のメッセージを確認）
- **コピー**: テキスト選択してコピー可能
- **クリア**: クリアボタンで全消去

**メッセージ種類**:
| 種類 | アイコン | 例 |
|------|:--------:|-----|
| エラー | ⚠️ | 「レイヤー画像のサイズがゲームエリアと一致しません」 |
| 警告 | ⚡ | 「未保存の変更があります」 |
| 情報 | ℹ️ | 「ステージを保存しました」 |
| ティップス | 💡 | 「Shiftキーを押しながらブラシを使うと消しゴムモードになります」 |

### 3.9. ゲーム画面UI (Game Screen UI)

**HUD（画面上部）**:
```
💎 5              SCORE: 12,500              ❤️❤️❤️
```
- ジェム所持数（左）
- スコア（中央）
- 残機（右）

**ボスHPバー**:
- ボスキャラの頭上に表示
- HP減少でゲージが短くなる

**ウエポンパネル（画面下部）**:
```
┌────┐ ┌────┐ ┌────┐ ┌────┐ ┌────┐ ┌────┐ ┌────┐
│SLOW│ │EXPD│ │DBLE│ │LASR│ │SHLD│ │MGNT│ │GHST│
│ ●  │ │ ●● │ │ ●● │ │●●●│ │●●●●│ │●●●●│ │●●●●│
│ [1]│ │ [2]│ │ [3]│ │ [4]│ │ [5]│ │ [6]│ │ [7]│
└────┘ └────┘ └────┘ └────┘ └────┘ └────┘ └────┘
```
- 横並びで7種表示
- ●はコスト表示
- ジェム不足時はグレーアウト
- **発動中**: 枠内が残り時間ゲージに切り替わる（秒数表示なし）

**ティップス表示（画面最下部）**:
- 1行表示（読み取り専用）
- ゲーム中の特定タイミングで表示
- 将来的にスクリプトで制御可能にする予定

### 3.10. 入力操作仕様 (Input Interactions)

#### マウス操作
- **左クリック (Left Click)**:
    - ツールのメインアクション実行（描画、選択、移動など）。
    - 線分ツール: 頂点追加 / ドラッグして移動。
- **右クリック (Right Click)**:
    - **ツール切り替え**: ブラシ → 消しゴム → 線分 → ブラシ... の順でサイクル切り替えを行う。
    - **線分編集時**:
        - 描画中: 最後の頂点をキャンセル（Back）。
        - 選択中（頂点上）: 頂点を削除。
- **ダブルクリック (Double Click)**:
    - 線分ツール: 描画を完了（確定）する。
    - 選択中線分上: その位置に頂点を追加する。
- **ホイール (Wheel)**:
    - ズームイン/アウトを実行。
    - `Ctrl` + ホイール: 上下スクロール（パンの代替手段）。

## 4. ファイル・データ管理 (File & Data Management)

### 4.1. ファイル区分
エディタの保存形式と、ゲーム用の出力形式を明確に区別する。

#### A. プロジェクトファイル (`.hbp`)
- **用途**: エディタの編集状態をすべて保存するマスターファイル。
- **範囲**: 全ステージ、全レイヤー、ブロックストック、ガイド画像、エディタ設定。
- **形式**: JSON (拡張子 `.hbp` または `.json`)。
- **保存タイミング**: `Ctrl+S` またはメニュー「保存」。

#### B. ステージデータ (`.json`)
- **用途**: ゲームエンジンが読み込むための実行用データ。
- **範囲**: 単一のステージ情報（正規化されたグリッド、配置ブロック、ライン、メタデータ）。
- **形式**: JSON。
- **出力方法**: メニュー「エクスポート」から特定のステージを選んで出力（または一括出力）。

### 4.2. プロジェクトデータ構造 (`.hbp`)

**プロジェクトは複数のステージを含み、各ステージが独立したデータを持つ。**

```json
{
  "version": "5.0",
  "projectName": "MyGame",
  "stages": [
    {
      "id": "stage_001",
      "name": "Stage 1",
      "canvas": { "width": 1280, "height": 720 },
      "gridSize": "medium",
      "layers": [
        {
          "id": 1,
          "name": "背景",
          "type": "image",
          "visible": true,
          "zIndex": 0,
          "imageData": "data:image/png;base64,..."
        },
        {
          "id": 2,
          "name": "ブロック",
          "type": "block",
          "visible": true,
          "zIndex": 1,
          "sourceLayerId": 1,
          "blocks": [
            ["0,0", {"row": 0, "col": 0, "durability": 1, "color": "#64B5F6"}],
            ["1,0", {"row": 1, "col": 0, "durability": 2, "gemDrop": "guaranteed"}]
          ]
        }
      ],
      "lines": [
        {
          "id": "line_001",
          "points": [{"x": 0, "y": 0}, {"x": 1280, "y": 0}],
          "type": "collision",
          "color": "#FFFF00",
          "thickness": 3
        }
      ],
      "meta": {
        "initialLives": 3,
        "clearBonus": 1000,
        "powerGemChance": 0.15,
        "resetGemsOnClear": false,
        "blockGuide": { "enabled": true, "probability": 0.5, "angleLimit": 30 },
        "boss": null
      }
    },
    {
      "id": "stage_boss",
      "name": "Boss Stage",
      "canvas": { "width": 1920, "height": 1080 },
      "gridSize": "large",
      "layers": [
        {
          "id": 1,
          "name": "背景",
          "type": "image",
          "visible": true,
          "zIndex": 0,
          "imageData": "data:image/png;base64,..."
        }
      ],
      "lines": [],
      "meta": {
        "initialLives": 3,
        "boss": {
          "enabled": true,
          "centerBlock": {"row": 5, "col": 10},
          "hitPoints": 10,
          "speed": 2.0,
          "movementPattern": "random",
          "abilities": ["regenerate", "catch", "debuff"]
        }
      }
    }
  ]
}
```

> **変更点 (v5.0)**:
> - `canvas`, `gridSize` をプロジェクトからステージ内に移動
> - `layers`, `lines` をプロジェクトからステージ内に移動（各ステージ独立）
> - ステージ間でレイヤーは共有しない（`layerIds` による参照を廃止）

### 4.3. ゲームステージデータ構造 (`stage_xx.json`)

エクスポート時に生成される、ゲームエンジン用の軽量データ。

```json
{
  "version": "4.0",
  "stageName": "Stage 1",
  "canvas": { "width": 1280, "height": 720 },
  "gridSize": { "radius": 30, "width": 52, "height": 60, "verticalSpacing": 45 },
  
  "backgrounds": [
    { "imageData": "data:image/png;base64,...", "zIndex": 0 }
  ],
  
  "blocks": [
    { "row": 0, "col": 0, "durability": 1, "color": "#64B5F6" },
    { "row": 1, "col": 0, "durability": 2, "gemDrop": "guaranteed" },
    { "row": 2, "col": 0, "gemDrop": "infinite" },
    { "row": 3, "col": 0, "blockType": "key", "keyId": "key_001" },
    { "row": 4, "col": 0, "blockType": "lock", "linkedKeyId": "key_001", "durability": 2 }
  ],
  
  "lines": [
    { "id": "line_001", "type": "collision", "points": [...], "blockGuide": {...} },
    { "id": "line_002", "type": "paddle", "points": [...], "paddleControl": "mouse-x" },
    { "id": "line_003", "type": "missline", "points": [...] }
  ],
  
  "meta": {
    "initialLives": 3,
    "clearBonus": 1000,
    "powerGemChance": 0.15,
    "resetGemsOnClear": false,
    "blockGuide": { "enabled": true, "probability": 0.5, "angleLimit": 30 },
    "weaponCosts": { "slow": 1, "wide": 2, "double": 2, "laser": 3, "shield": 4, "magnet": 4, "ghost": 4 },
    "allowedWeapons": ["slow", "wide", "double", "laser", "shield", "magnet", "ghost"]
  },
  
  "boss": {
    "enabled": true,
    "centerBlock": {"row": 5, "col": 10},
    "hitPoints": 10,
    "speed": 2.0,
    "movementPattern": "random",
    "abilities": ["regenerate", "catch", "debuff"],
    "regenerateCooldown": 5000,
    "debuffTypes": ["slow", "reverse", "short", "disarm"]
  }
}
```

## 5. モジュール構成 (Module Architecture)

機能ごとにファイルを分割し、保守性を高める。

```
/ (Root)
├── index.html              # エディタのエントリーポイント
├── game_index.html         # ゲーム確認用エントリーポイント
├── css/
│   ├── editor.css          # エディタ用スタイル
│   ├── game.css            # ゲーム用スタイル
│   └── ui.css              # 共通UIスタイル
├── editor/
│   ├── core/
│   │   ├── Editor.js       # エディタのメインクラス (Controller)
│   │   ├── Config.js       # エディタ設定・定数
│   │   └── Events.js       # イベントハンドリング
│   ├── managers/
│   │   ├── LayerManager.js # レイヤー管理
│   │   ├── StageManager.js # ステージ管理
│   │   ├── BlockManager.js # ブロック操作・ストック管理
│   │   └── LineManager.js  # ライン操作管理
│   ├── systems/
│   │   ├── RenderSystem.js # エディタ描画（Canvas操作）
│   │   ├── FileSystem.js   # 保存・読み込み・エクスポート
│   │   └── History.js      # Undo/Redo管理
│   └── ui/
│       ├── UIController.js # UIイベント仲介
│       ├── Layout.js       # パネルレイアウト管理
│       ├── Tools.js        # ツールバー・ツール挙動
│       └── Dialogs.js      # 各種設定ダイアログ
├── game/
│   ├── Game.js             # ゲームメインクラス
│   ├── core/               # (Input, Audio, Constants...)
│   ├── entities/           # (Ball, Paddle, Block, Item...)
│   └── physics/            # (Collision, HexMath...)
└── shared/
    ├── HexMath.js          # エディタ・ゲーム共通の数学関数
    └── Renderer.js         # エディタ・ゲーム共通の描画関数
```

### 5.2. 共有描画モジュール (Shared Renderer)

エディターとゲームで**同一の描画結果**を保証するため、`shared/Renderer.js` に描画ロジックを集約している。

#### 提供関数

| 関数 | 用途 |
|------|------|
| `drawHexBlock(ctx, x, y, radius, color, options)` | ヘックスブロック描画（エンボス込み） |
| `drawLine(ctx, line, options)` | ライン描画（タイプ別スタイル適用） |
| `drawLines(ctx, lines, options)` | 複数ライン一括描画 |

#### 設定 (`RENDER_CONFIG`)

```javascript
{
    block: {
        gap: 2,           // ブロック間隙間（radius減算値）
        emboss: {
            inset: 3,     // エンボス内側オフセット
            highlight: 'rgba(255, 255, 255, 0.4)',
            shadow: 'rgba(0, 0, 0, 0.4)',
            lineWidth: 2
        }
    },
    line: {
        collision: { dashPattern: [], label: null },
        paddle: { dashPattern: [5, 3], label: { text: 'PADDLE', ... } },
        missline: { dashPattern: [10, 5], label: { text: 'MISS LINE', ... } },
        decoration: { dashPattern: [], label: null }
    }
}
```

#### 使用箇所

- **エディター**: `RenderSystem.js` が `drawHexBlock`, `drawLine` をインポート
- **ゲーム**: `Game.js` が `drawHexBlock`, `drawLines` をインポート

> **設計方針**: 描画に関するロジックは必ず `shared/Renderer.js` を経由させ、エディターで見た目がゲームと異なる状況を防止する。

## 6. 重要な機能ロジック (Key Logic)

### 6.1. ブロック化 (Blockify)
画像レイヤーからブロックレイヤーを生成する機能。
1. 画像のピクセルデータをスキャン。
2. グリッドの各ヘックス中心点に対応するピクセルのアルファ値を確認。
3. アルファ値が閾値（例: 10%）以上であれば、その座標にブロックを生成。

### 6.2. 差分ブロック化 (Diff Blockify)
「服を着ている状態」と「脱衣状態」などの差分からブロックを生成する機能。
1. 2つの画像レイヤーを選択して実行。
2. ピクセル差分を計算。
3. 差分がある領域に対応するヘックス位置にブロックを生成。
4. これにより「破壊可能な服ブロック」などを自動生成する。

### 6.3. ツール挙動の統一
- **ブラシツール**:
    - **ブロックレイヤー選択時**: マウスドラッグでブロックを追加（「描く」）。
    - **画像レイヤー選択時**: 何もしない（または禁止カーソル）。
    - **Shiftキー**: 消しゴムモードに一時切り替え。
- **アイテムツール (New)**:
    - ブロックをクリックして、そのブロックに「アイテム」プロパティを付与する。
    - 右クリックでアイテム削除。
- **特殊ブロック設定ツール (New)**:
    - **種類変更**: 選択したブロックを `Normal` / `Hardening` / `Lock` / `Key` に切り替え。
    - **リンクモード**: KeyブロックとLockブロックを順にクリックして紐付け (`linkedBlockId`) を設定。エディタ上では矢印ラインで可視化。
- **ラインツール**:
    - レイヤー選択に関わらず、常に `lines` 配列に対してデータを追加する。
    - キャンバス上の最前面に描画される（UI的には）。

### 6.4. ステージメタデータ編集
- 専用のダイアログ (`SettingsDialog`) を設け、以下の項目を編集可能にする。
    - 背景色
    - ステージごとの残機数、制限時間
    - 重力設定 (Gravity Override)
    - 使用可能アイテム制限

## 7. 技術スタック (Tech Stack)
- **言語**: JavaScript (ES2022+, Modules) - Vanilla JS構成。
- **レンダリング**: HTML5 Canvas API (OffscreenCanvas for caching)。
- **スタイリング**: CSS3 (Grid/Flexbox, Custom Properties for theming)。
- **開発サーバー**: Python `http.server` (Port 8001), `npm run start` 等。
- **依存ライブラリ**: なし (No external logic libraries).
- **アイコン**: FontAwesome (CDN) または SVG直書き。
